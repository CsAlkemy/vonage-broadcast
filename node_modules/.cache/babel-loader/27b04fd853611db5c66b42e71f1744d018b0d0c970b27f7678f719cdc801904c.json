{"ast":null,"code":"/* global OT OTSolution OTKAnalytics ScreenSharingAccPack define */\n(function () {\n  /** Include external dependencies */\n  var _;\n  var $;\n  var OTKAnalytics;\n  if (typeof module === 'object' && typeof module.exports === 'object') {\n    /* eslint-disable import/no-unresolved */\n    _ = require('underscore');\n    $ = require('jquery');\n    OTKAnalytics = require('opentok-solutions-logging');\n    /* eslint-enable import/no-unresolved */\n  } else {\n    _ = this._;\n    $ = this.$;\n    OTKAnalytics = this.OTKAnalytics;\n  }\n\n  /** Private variables */\n  var _this;\n  var _accPack;\n  var _session;\n  var _canvas;\n  var _subscribingToMobileScreen;\n  var _elements = {};\n\n  /** Analytics */\n  var _otkanalytics;\n\n  // vars for the analytics logs. Internal use\n  var _logEventData = {\n    clientVersion: 'js-vsol-2.0.59',\n    // x.y.z filled by npm build script\n    componentId: 'annotationsAccPack',\n    name: 'guidAnnotationsKit',\n    actionInitialize: 'Init',\n    actionStart: 'Start',\n    actionEnd: 'End',\n    actionFreeHand: 'FreeHand',\n    actionPickerColor: 'PickerColor',\n    actionText: 'Text',\n    actionScreenCapture: 'ScreenCapture',\n    actionErase: 'Erase',\n    actionUseToolbar: 'UseToolbar',\n    variationAttempt: 'Attempt',\n    variationError: 'Failure',\n    variationSuccess: 'Success'\n  };\n  var _logAnalytics = function () {\n    // init the analytics logs\n    var _source = window.location.href;\n    var otkanalyticsData = {\n      clientVersion: _logEventData.clientVersion,\n      source: _source,\n      componentId: _logEventData.componentId,\n      name: _logEventData.name\n    };\n    _otkanalytics = new OTKAnalytics(otkanalyticsData);\n    var sessionInfo = {\n      sessionId: _session.id,\n      connectionId: _session.connection.connectionId,\n      partnerId: _session.apiKey\n    };\n    _otkanalytics.addSessionInfo(sessionInfo);\n  };\n  var _log = function (action, variation) {\n    var data = {\n      action: action,\n      variation: variation\n    };\n    _otkanalytics.logEvent(data);\n  };\n\n  /** End Analytics */\n\n  // Check for DOM element or string.  Return element.\n  var _getElem = function (el) {\n    return typeof el === 'string' ? document.querySelector(el) : el;\n  };\n\n  // Trigger event via common layer API\n  var _triggerEvent = function (event, data) {\n    if (_accPack) {\n      _accPack.triggerEvent(event, data);\n    }\n  };\n  var _registerEvents = function () {\n    if (_accPack) {\n      var events = ['startAnnotation', 'linkAnnotation', 'resizeCanvas', 'annotationWindowClosed', 'endAnnotation'];\n      _accPack.registerEvents(events);\n    }\n  };\n  var _setupUI = function () {\n    var toolbar = ['<div id=\"annotationToolbarContainer\" class=\"ots-annotation-toolbar-container\">', '<div id=\"toolbar\"></div>', '</div>'].join('\\n');\n    $('body').append(toolbar);\n    _log(_logEventData.actionUseToolbar, _logEventData.variationSuccess);\n  };\n  var _palette = ['#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#8e44ad', '#f1c40f', '#e67e22', '#e74c3c', '#ded5d5'];\n  var _aspectRatio = 10 / 6;\n\n  /** Private methods */\n\n  var _refreshCanvas = _.throttle(function () {\n    _canvas.onResize();\n  }, 1000);\n\n  /** Resize the canvas to match the size of its container */\n  var _resizeCanvas = _.throttle(function () {\n    var width;\n    var height;\n    var cobrowsing = !!_elements.cobrowsingImage;\n    if (cobrowsing) {\n      // Cobrowsing images are currently fixed size, so resize isn't needed\n      return;\n    }\n    if (_elements.cobrowsingImage === null) {\n      var el = _elements.absoluteParent || _elements.canvasContainer;\n      width = el.clientWidth;\n      height = el.clientHeight;\n    }\n    try {\n      var videoDimensions = _canvas.videoFeed.stream.videoDimensions;\n    } catch (e) {\n      console.log('OT Annotation: Annotation video stream no longer exists');\n      return;\n    }\n\n    // Override dimensions when subscribing to a mobile screen\n    if (_subscribingToMobileScreen) {\n      videoDimensions.width = width;\n      videoDimensions.height = height;\n    }\n    var origRatio = videoDimensions.width / videoDimensions.height;\n    var destRatio = width / height;\n    var calcDimensions = {\n      top: 0,\n      left: 0,\n      height: height,\n      width: width\n    };\n    if (!_elements.externalWindow) {\n      if (origRatio < destRatio) {\n        // height is the limiting prop, we'll get vertical bars\n        calcDimensions.width = calcDimensions.height * origRatio;\n        calcDimensions.left = (width - calcDimensions.width) / 2;\n      } else {\n        calcDimensions.height = calcDimensions.width / origRatio;\n        calcDimensions.top = (height - calcDimensions.height) / 2;\n      }\n    }\n    $(_elements.canvasContainer).find('canvas').css(calcDimensions);\n    $(_elements.canvasContainer).find('canvas').attr(calcDimensions);\n    _refreshCanvas();\n    _triggerEvent('resizeCanvas');\n  }, 500, {\n    trailing: false\n  });\n  var _changeColorByIndex = function (colorIndex) {\n    _canvas.changeColorByIndex(colorIndex);\n  };\n  var _takeScreenShot = function () {\n    _canvas.captureScreenshot(true);\n  };\n  var _listenForResize = function () {\n    $(_elements.resizeSubject).on('resize', _resizeCanvas);\n  };\n  var _createToolbar = function (session, options, externalWindow) {\n    _setupUI();\n    var toolbarId = _.property('toolbarId')(options) || 'toolbar';\n    var items = _.property('toolbarItems')(options) || [];\n    var shapes = _.property('toolbarShapes')(options) || [];\n    var colors = _.property('colors')(options) || _palette;\n    var imageAssets = _.property('imageAssets')(options) || null;\n    var backgroundColor = _.property('backgroundColor')(options) || null;\n    var container = function () {\n      var w = !!externalWindow ? externalWindow : window;\n      return w.document.getElementById(toolbarId);\n    };\n\n    /* eslint-disable no-native-reassign */\n    toolbar = new OTSolution.Annotations.Toolbar({\n      session: session,\n      container: container(),\n      colors: colors,\n      items: items.length ? items : ['*'],\n      shapes: shapes.length ? shapes : ['rectangle', 'oval', 'star', 'arrow', 'line'],\n      externalWindow: externalWindow || null,\n      imageAssets: imageAssets,\n      backgroundColor: backgroundColor,\n      OTKAnalytics: OTKAnalytics\n    });\n    toolbar.itemClicked(function (id) {\n      var actions = {\n        OT_pen: _logEventData.actionFreeHand,\n        OT_colors: _logEventData.actionPickerColor,\n        OT_text: _logEventData.actionText,\n        OT_clear: _logEventData.actionErase\n      };\n      var action = actions[id];\n      if (!!action) {\n        _log(action, _logEventData.variationSuccess);\n      }\n    });\n\n    /* eslint-enable no-native-reassign */\n  };\n\n  // Create external screen sharing window\n  var _createExternalWindow = function () {\n    var deferred = $.Deferred();\n    var width = screen.width * 0.80 | 0;\n    var height = width / _aspectRatio;\n    var externalWindowHTML = '<!DOCTYPE html><html lang=\"en\"><head><meta http-equiv=\"Content-type\" content=\"text/html; charset=utf-8\"><title>OpenTok Screen Sharing Solution Annotation</title><link rel=\"stylesheet\" href=\"https://assets.tokbox.com/solutions/css/style.css\"><style type=\"text/css\" media=\"screen\"> body{margin:0;background-color:rgba(0,153,203,.7);box-sizing:border-box;height:100vh}canvas{top:0;z-index:1000}.hidden{display:none}.ots-hidden{display:none !important}.main-wrap{width:100%;height:100%;-ms-box-orient:horizontal;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-moz-flex;display:-webkit-flex;display:flex;-webkit-justify-content:center;justify-content:center;-webkit-align-items:center;align-items:center}.inner-wrap{position:relative;border-radius:8px;overflow:hidden}.publisherContainer{display:block;background-color:#000;position:absolute}.publisher-wrap{height:100%;width:100%}.subscriberContainer{position:absolute;display:flex;top:20px;left:20px;width:200px;height:120px;background-color:#000;border:2px solid #fff;border-radius:6px}.subscriberContainer .OT_video-poster{width:100%;height:100%;opacity:.25;background-repeat:no-repeat;background-image:url(https://static.opentok.com/webrtc/v2.8.2/images/rtc/audioonly-silhouette.svg);background-size:50%;background-position:center}.OT_video-element{height:100%;width:100%}.OT_edge-bar-item{display:none}</style></head><body> <div class=\"main-wrap\"> <div id=\"annotationContainer\" class=\"inner-wrap\"></div></div><div id=\"toolbarContainer\" class=\"ots-annotation-toolbar-container\"> <div id=\"toolbar\" class=\"toolbar-wrap\"></div></div><div id=\"subscriberVideo\" class=\"subscriberContainer hidden\"></div><script type=\"text/javascript\" charset=\"utf-8\"> /** Must use double-quotes since everything must be converted to a string */ var opener; var canvas; if (!toolbar){alert(\"Something went wrong: You must pass an OpenTok annotation toolbar object into the window.\")}else{opener=window.opener; window.onbeforeunload=window.triggerCloseEvent;}var localScreenProperties={insertMode: \"append\", width: \"100%\", height: \"100%\", videoSource: \"window\", showControls: false, style:{buttonDisplayMode: \"off\"}, subscribeToVideo: \"true\", subscribeToAudio: \"false\", fitMode: \"contain\"}; var createContainerElements=function(){var parentDiv=document.getElementById(\"annotationContainer\"); var publisherContainer=document.createElement(\"div\"); publisherContainer.setAttribute(\"id\", \"screenshare_publisher\"); publisherContainer.classList.add(\"publisher-wrap\"); parentDiv.appendChild(publisherContainer); return{annotation: parentDiv, publisher: publisherContainer};}; var addSubscriberVideo=function(stream){var container=document.getElementById(\"subscriberVideo\"); var subscriber=session.subscribe(stream, container, localScreenProperties, function(error){if (error){console.log(\"Failed to add subscriber video\", error);}container.classList.remove(\"hidden\");});}; if (navigator.userAgent.indexOf(\"Firefox\") !==-1){var ghost=window.open(\"about:blank\"); ghost.focus(); ghost.close();}</script></body></html>';\n\n    /* eslint-disable max-len */\n    var windowFeatures = ['toolbar=no', 'location=no', 'directories=no', 'status=no', 'menubar=no', 'scrollbars=no', 'resizable=no', 'copyhistory=no', ['width=', width].join(''), ['height=', height].join(''), ['left=', screen.width / 2 - width / 2].join(''), ['top=', screen.height / 2 - height / 2].join('')].join(',');\n    /* eslint-enable max-len */\n\n    var annotationWindow = window.open('about:blank', '', windowFeatures);\n    annotationWindow.document.write(externalWindowHTML);\n    window.onbeforeunload = function () {\n      annotationWindow.close();\n    };\n\n    // External window needs access to certain globals\n    annotationWindow.toolbar = toolbar;\n    annotationWindow.OT = OT;\n    annotationWindow.session = _session;\n    annotationWindow.$ = $;\n    annotationWindow.triggerCloseEvent = function () {\n      _triggerEvent('annotationWindowClosed');\n    };\n    annotationWindow.onbeforeunload = function () {\n      _triggerEvent('annotationWindowClosed');\n    };\n\n    // TODO Find something better.\n    var windowReady = function () {\n      if (!!annotationWindow.createContainerElements) {\n        $(annotationWindow.document).ready(function () {\n          deferred.resolve(annotationWindow);\n        });\n      } else {\n        setTimeout(windowReady, 100);\n      }\n    };\n    windowReady();\n    return deferred.promise();\n  };\n\n  // Remove the toolbar and cancel event listeners\n  var _removeToolbar = function () {\n    _canvas.onClearAnnotation();\n    $(_elements.resizeSubject).off('resize', _resizeCanvas);\n    toolbar.remove();\n    $('#annotationToolbarContainer').remove();\n  };\n\n  // Determine whether or not the subscriber stream is from a mobile device\n  var _requestPlatformData = function (pubSub, mobileInitiator) {\n    if (!!pubSub.stream) {\n      var isPublisher = Object.prototype.hasOwnProperty.call(pubSub, 'accessAllowed');\n      _session.signal({\n        type: 'otAnnotation_requestPlatform',\n        to: pubSub.stream.connection\n      });\n      _session.on('signal:otAnnotation_mobileScreenShare', function (event) {\n        var platform = event.data ? JSON.parse(event.data).platform : null;\n        var isMobile = platform == 'ios' || platform === 'android';\n        _subscribingToMobileScreen = isMobile;\n        _canvas.onMobileScreenShare(isMobile, isPublisher);\n      });\n    }\n    if (mobileInitiator) {\n      _subscribingToMobileScreen = true;\n      _canvas.onMobileScreenShare(true);\n    }\n  };\n\n  /**\n   * Creates an external window (if required) and links the annotation toolbar\n   * to the session\n   * @param {object} session\n   * @param {object} [options]\n   * @param {boolean} [options.screensharing] - Using an external window\n   * @param {string} [options.toolbarId] - If the container has an id other than 'toolbar'\n   * @param {array} [options.items] - Custom set of tools\n   * @param {array} [options.colors] - Custom color palette\n   * @returns {promise} < Resolve: undefined | {object} Reference to external annotation window >\n   */\n  var start = function (session, options) {\n    var deferred = $.Deferred();\n    if (_.property('screensharing')(options)) {\n      _createExternalWindow().then(function (externalWindow) {\n        _createToolbar(session, options, externalWindow);\n        toolbar.createPanel(externalWindow);\n        _triggerEvent('startAnnotation', externalWindow);\n        _log(_logEventData.actionStart, _logEventData.variationSuccess);\n        deferred.resolve(externalWindow);\n      });\n    } else {\n      _createToolbar(session, options);\n      _triggerEvent('startAnnotation');\n      _log(_logEventData.actionStart, _logEventData.variationSuccess);\n      deferred.resolve();\n    }\n    return deferred.promise();\n  };\n\n  /**\n   * @param {object} pubSub - Either the publisher(sharing) or subscriber(viewing)\n   * @ param {object} container - The parent container for the canvas element\n   * @ param {object} options\n   * @param {object} options.canvasContainer - The id of the parent for the annotation canvas\n   * @param {object | string} [options.externalWindow] - Reference to the annotation window (or query selector) if publishing\n   * @param {array | string} [options.absoluteParent] - Reference to element (or query selector) for resize if other than container\n   * * @param {Boolean} [options.mobileInitiator] - Is cobrowsing being initiated by a mobile device\n   */\n  var linkCanvas = function (pubSub, container, options) {\n    /**\n     * jQuery only allows listening for a resize event on the window or a\n     * jQuery resizable element, like #wmsFeedWrap.  windowRefernce is a\n     * reference to the popup window created for annotation.  If this doesn't\n     * exist, we are watching the canvas belonging to the party viewing the\n     * shared screen\n     */\n    _elements.resizeSubject = _getElem(_.property('externalWindow')(options) || window);\n    _elements.externalWindow = _getElem(_.property('externalWindow')(options) || null);\n    _elements.absoluteParent = _getElem(_.property('absoluteParent')(options) || null);\n    _elements.cobrowsingImage = _getElem(_.property('cobrowsingImage')(options) || null);\n    _elements.canvasContainer = _getElem(container);\n\n    // The canvas object\n    _canvas = new OTSolution.Annotations({\n      feed: pubSub,\n      container: _elements.canvasContainer,\n      externalWindow: _elements.externalWindow\n    });\n    toolbar.addCanvas(_canvas, _elements.externalWindow);\n    var onScreenCapture = _this.options.onScreenCapture ? _this.options.onScreenCapture : function (dataUrl) {\n      var win = window.open(dataUrl, '_blank');\n      win.focus();\n    };\n    _canvas.onScreenCapture(onScreenCapture);\n    _requestPlatformData(pubSub, options && options.mobileInitiator);\n    var context = _elements.externalWindow ? _elements.externalWindow : window;\n    // The canvas DOM element\n    _elements.canvas = $(_.first(context.document.getElementsByTagName('canvas')));\n    _listenForResize();\n    _resizeCanvas();\n    _triggerEvent('linkAnnotation');\n  };\n\n  /**\n   * Manually update the size of the canvas to match it's container, or the\n   * absolute parent, if defined.\n   */\n  var resizeCanvas = function () {\n    _resizeCanvas();\n  };\n\n  /**\n   * Change the annotation color of the toolbar passing the colorIndex\n   * @param {Integer} colorIndex - The color index number\n   */\n  var changeColorByIndex = function (colorIndex) {\n    _changeColorByIndex(colorIndex);\n  };\n  var takeScreenShot = function () {\n    _takeScreenShot();\n  };\n\n  /**\n   * Adds a subscriber's video the external annotation window\n   * @param {Object} stream - The subscriber stream object\n   */\n  var addSubscriberToExternalWindow = function (stream) {\n    if (!_elements.externalWindow) {\n      console.log('OT Annotation: External window does not exist. Cannot add subscriber video.');\n    } else {\n      _elements.externalWindow.addSubscriberVideo(stream);\n    }\n  };\n\n  /**\n   * Stop annotation and clean up components\n   * @param {Boolean} publisher Are we the publisher?\n   */\n  var end = function () {\n    _removeToolbar();\n    _elements.canvas = null;\n    if (!!_elements.externalWindow) {\n      _elements.externalWindow.close();\n      _elements.externalWindow = null;\n      _elements.resizeSubject = null;\n    }\n    _triggerEvent('endAnnotation');\n    _log(_logEventData.actionEnd, _logEventData.variationSuccess);\n  };\n  var hideToolbar = function () {\n    $(toolbar.parent).hide();\n  };\n  var showToolbar = function () {\n    $(toolbar.parent).show();\n  };\n\n  /**\n   * @constructor\n   * Represents an annotation component, used for annotation over video or a shared screen\n   * @param {object} options\n   * @param {object} options.session - An OpenTok session\n   * @param {object} options.canvasContainer - The id of the parent for the annotation canvas\n   * @param {object} options.watchForResize - The DOM element to watch for resize\n   * @param {object} options.onScreenCapture- A callback function to be invoked on screen capture\n   */\n  var AnnotationAccPack = function (options) {\n    _this = this;\n    _this.options = _.omit(options, 'accPack', 'session');\n    _accPack = _.property('accPack')(options);\n    _session = _.property('session')(options);\n    if (!_session) {\n      throw new Error('OpenTok Annotation Accelerator Pack requires an OpenTok session');\n    }\n    _registerEvents();\n    // init analytics logs\n    _logAnalytics();\n    _log(_logEventData.actionInitialize, _logEventData.variationSuccess);\n  };\n  AnnotationAccPack.prototype = {\n    constructor: AnnotationAccPack,\n    start: start,\n    linkCanvas: linkCanvas,\n    resizeCanvas: resizeCanvas,\n    addSubscriberToExternalWindow: addSubscriberToExternalWindow,\n    end: end,\n    hideToolbar: hideToolbar,\n    showToolbar: showToolbar,\n    changeColorByIndex: changeColorByIndex,\n    takeScreenShot: takeScreenShot\n  };\n  if (typeof exports === 'object') {\n    module.exports = AnnotationAccPack;\n  } else if (typeof define === 'function' && define.amd) {\n    define(function () {\n      return AnnotationAccPack;\n    });\n  } else {\n    this.AnnotationAccPack = AnnotationAccPack;\n  }\n}).call(this);\n\n/*!\n *  Annotation Plugin for OpenTok\n *\n *  @Author: Trevor Boyer\n *  @Copyright (c) 2015 TokBox, Inc\n **/\n\n/* eslint-disable */\n\n/** Analytics */\n(function () {\n  var _OTKAnalytics;\n  var _otkanalytics;\n  var _session;\n\n  // vars for the analytics logs. Internal use\n  var _logEventData = {\n    clientVersion: 'js-vsol-2.0.59',\n    // x.y.z filled by npm build script\n    componentId: 'annotationsAccPack',\n    name: 'guidAnnotationsKit',\n    actionStartDrawing: 'StartDrawing',\n    actionEndDrawing: 'EndDrawing',\n    variationSuccess: 'Success'\n  };\n  var _logAnalytics = function () {\n    // init the analytics logs\n    var _source = window.location.href;\n    var otkanalyticsData = {\n      clientVersion: _logEventData.clientVersion,\n      source: _source,\n      componentId: _logEventData.componentId,\n      name: _logEventData.name\n    };\n    _otkanalytics = new _OTKAnalytics(otkanalyticsData);\n    var sessionInfo = {\n      sessionId: _session.id,\n      connectionId: _session.connection.connectionId,\n      partnerId: _session.apiKey\n    };\n    _otkanalytics.addSessionInfo(sessionInfo);\n  };\n  var _log = function (action, variation) {\n    var data = {\n      action: action,\n      variation: variation\n    };\n    _otkanalytics.logEvent(data);\n  };\n\n  /** End Analytics */\n\n  //--------------------------------------\n  //  OPENTOK ANNOTATION CANVAS/VIEW\n  //--------------------------------------\n  var DEFAULT_ASSET_URL = 'https://assets.tokbox.com/solutions/images/';\n  OTSolution = this.OTSolution || {};\n  OTSolution.Annotations = function (options) {\n    options = options || {};\n    this.widgetVersion = 'js-1.0.0-beta';\n    this.parent = options.container;\n    this.videoFeed = options.feed;\n    this.imageAssets = options.imageAssets || DEFAULT_ASSET_URL;\n    _OTKAnalytics = _OTKAnalytics || options.OTKAnalytics;\n    if (!_otkanalytics) {\n      _logAnalytics();\n    }\n    if (typeof module === 'object' && typeof module.exports === 'object') {\n      $ = require('jquery');\n    }\n    var context = options.externalWindow ? options.externalWindow.document : window.document;\n    var self = this;\n    if (this.parent) {\n      var canvas = document.createElement('canvas');\n      canvas.setAttribute('id', 'opentok_canvas'); // session.connection.id?\n      canvas.style.position = 'absolute';\n      this.parent.appendChild(canvas);\n      canvas.setAttribute('width', this.parent.clientWidth + 'px');\n      canvas.style.width = window.getComputedStyle(this.parent).width;\n      canvas.setAttribute('height', this.parent.clientHeight + 'px');\n      canvas.style.height = window.getComputedStyle(this.parent).height;\n    }\n    function VideoRelativeCoordinateSet(update) {\n      var returnedObj = {};\n      var scale = {\n        get X() {\n          if (publishingScreenToMobileDevice || cobrowsing && subscribingToMobileScreen) {\n            return update.canvasWidth / canvas.width;\n          }\n          var width = cobrowsing ? canvas.width : self.videoFeed.stream.videoDimensions.width;\n          return width / canvas.width;\n        },\n        get Y() {\n          if (publishingScreenToMobileDevice || cobrowsing && subscribingToMobileScreen) {\n            return update.canvasHeight / canvas.height;\n          }\n          var height = cobrowsing ? canvas.height : self.videoFeed.stream.videoDimensions.height;\n          return height / canvas.height;\n        }\n      };\n      Object.keys(update).forEach(function (attr) {\n        returnedObj[attr] = update[attr];\n      });\n      ['X', 'Y'].forEach(function (coord) {\n        ['to', 'from', 'last', 'm', 'start', 'point'].forEach(function (verb) {\n          var attr = verb + coord;\n          returnedObj['_' + attr] = returnedObj[attr];\n          Object.defineProperty(returnedObj, attr, {\n            get: function () {\n              return returnedObj['_' + attr] / scale[coord];\n            },\n            set: function (newVal) {\n              returnedObj['_' + attr] = newVal; // * scale[coord];\n            }\n          });\n        });\n      });\n      return returnedObj;\n    }\n    var self = this;\n    var ctx;\n    var cbs = [];\n    var isPublisher;\n    var mirrored;\n    var scaledToFill;\n    var batchUpdates = [];\n    var drawHistory = [];\n    var drawHistoryReceivedFrom = [];\n    var updateHistory = [];\n    var eventHistory = [];\n    var isStartPoint = false;\n    var isVideo = self.videoFeed && self.videoFeed.element ? true : false;\n    var cobrowsing = !self.videoFeed.stream;\n    var subscribingToMobileScreen = false;\n    var publishingScreenToMobileDevice = false;\n    var client = new VideoRelativeCoordinateSet({\n      dragging: false\n    });\n\n    // INFO Mirrored feeds contain the OT_mirrored class\n    if (isVideo) {\n      isPublisher = (' ' + self.videoFeed.element.className + ' ').indexOf(' ' + 'OT_publisher' + ' ') > -1;\n      mirrored = isPublisher ? (' ' + self.videoFeed.element.className + ' ').indexOf(' ' + 'OT_mirrored' + ' ') > -1 : false;\n      scaledToFill = (' ' + self.videoFeed.element.className + ' ').indexOf(' ' + 'OT_fit-mode-cover' + ' ') > -1;\n    } else {\n      mirrored = false;\n      scaledToFill = false;\n    }\n    this.canvas = function () {\n      return canvas;\n    };\n\n    /**\n     * Links an OpenTok session to the annotation canvas. Typically, this is automatically linked\n     * when using {@link Toolbar#addCanvas}.\n     * @param session The OpenTok session.\n     */\n    this.link = function (session) {\n      this.session = session;\n    };\n\n    /**\n     * Changes the active annotation color for the canvas.\n     * @param color The hex string representation of the color (#rrggbb).\n     */\n    this.changeColor = function (color) {\n      self.userColor = color;\n      if (!self.lineWidth) {\n        self.lineWidth = 2; // TODO Default to first option in list of line widths\n      }\n    };\n\n    /**\n     * Changes the active annotation color for the canvas.\n     * @param colorIndex - the index regarding the colors array\n     */\n    this.changeColorByIndex = function (colorIndex) {\n      //set the user color\n      self.userColor = this.colors[colorIndex];\n\n      //activate the change on the toolbar\n      var colorChoices = context.querySelectorAll('.color-choice');\n      colorChoices[colorIndex].classList.add('active');\n      var button = context.getElementById('OT_colors');\n      button.setAttribute('class', 'OT_color annotation-btn colors');\n      button.style.borderRadius = '50%';\n      button.style.backgroundColor = this.colors[colorIndex];\n    };\n\n    /**\n     * Changes the line/stroke width of the active annotation for the canvas.\n     * @param size The size in pixels.\n     */\n    this.changeLineWidth = function (size) {\n      this.lineWidth = size;\n    };\n\n    /**\n     * Sets the selected menu item from the toolbar. This is typically handled\n     * automatically by the toolbar, but can be used to programmatically select an item.\n     * @param item The menu item to set as selected.\n     */\n    this.selectItem = function (item) {\n      if (self.overlay) {\n        self.parent.removeChild(self.overlay);\n        self.overlay = null;\n      }\n\n      /**\n       * Update classes for toolbar items\n       */\n      var updateSelected = function () {\n        // Remove the 'selected' class from the currently selected item (or parent)\n        var current = context.getElementById(self.selectedItem.id);\n        var shapesBtn = context.getElementById('OT_shapes');\n        var currentIsShape = shapesBtn.classList.contains('selected');\n        currentIsShape ? shapesBtn.classList.remove('selected') : current.classList.remove('selected');\n\n        // If the newly selected item is a shape, update the shapes subpanel button\n        var newlySelected = context.getElementById(item.id);\n        if (newlySelected.parentElement.classList.contains('shapes')) {\n          shapesBtn.classList.add('selected');\n        } else {\n          newlySelected.classList.add('selected');\n        }\n      };\n      if (item && item.id === 'OT_capture') {\n        self.captureScreenshot();\n      } else if (item && item.id.indexOf('OT_line_width') !== -1) {\n        if (item.size) {\n          self.changeLineWidth(item.size);\n        }\n        // 'undo' and 'clear' are actions, not items that can be selected\n      } else if (item.id !== 'OT_undo' && item.id !== 'OT_clear') {\n        updateSelected();\n        self.selectedItem = item;\n      }\n    };\n\n    /**\n     * Sets the color palette for the color picker\n     * @param colors The array of hex color strings (#rrggbb).\n     */\n    this.colors = function (colors) {\n      this.colors = colors;\n      this.changeColor(colors[0]);\n    };\n\n    /**\n     * Clears the canvas for the active user. Only annotations added by the active OpenTok user will\n     * be removed, leaving the history of all other annotations.\n     */\n    this.clear = function () {\n      clearCanvas(false, self.session.connection.connectionId);\n      if (self.session) {\n        self.session.signal({\n          type: 'otAnnotation_clear'\n        });\n      }\n    };\n    this.undo = function () {\n      undoLast(false, self.session.connection.connectionId);\n    };\n\n    // TODO Allow the user to choose the image type? (jpg, png) Also allow size?\n    /**\n     * Captures a screenshot of the annotations displayed on top of the active video feed.\n     */\n    this.captureScreenshot = function (isAnnotationEnd) {\n      var canvasCopy = document.createElement('canvas');\n      canvasCopy.width = canvas.width;\n      canvasCopy.height = canvas.height;\n      var width = isVideo ? self.videoFeed.videoWidth() : canvas.width;\n      var height = isVideo ? self.videoFeed.videoHeight() : canvas.height;\n      var scale = 1;\n      var offsetX = 0;\n      var offsetY = 0;\n      if (scaledToFill) {\n        if (width < height) {\n          scale = canvas.width / width;\n          width = canvas.width;\n          height = height * scale;\n        } else {\n          scale = canvas.height / height;\n          height = canvas.height;\n          width = width * scale;\n        }\n        // If stretched to fill, we need an offset to center the image\n        offsetX = (width - canvas.width) / 2;\n        offsetY = (height - canvas.height) / 2;\n      } else {\n        if (width > height) {\n          scale = canvas.width / width;\n          width = canvas.width;\n          height = height * scale;\n          offsetX = 0;\n          offsetY = (canvas.height - height) / 2;\n        } else {\n          scale = canvas.height / height;\n          height = canvas.height;\n          width = width * scale;\n          offsetX = (canvas.width - width) / 2;\n          offsetY = 0;\n        }\n      }\n\n      // Combine the video and annotation images\n      var image = new Image();\n      image.onload = function () {\n        var ctxCopy = canvasCopy.getContext('2d');\n        if (mirrored) {\n          ctxCopy.translate(width, 0);\n          ctxCopy.scale(-1, 1);\n        }\n        ctxCopy.drawImage(image, offsetX, offsetY, width, height);\n\n        // We want to make sure we draw the annotations the same way, so we need to flip back\n        if (mirrored) {\n          ctxCopy.translate(width, 0);\n          ctxCopy.scale(-1, 1);\n        }\n        ctxCopy.drawImage(canvas, 0, 0);\n        cbs.forEach(function (cb) {\n          var data = {\n            src: canvasCopy.toDataURL(),\n            isAnnotationEnd: isAnnotationEnd\n          };\n          cb.call(self, data);\n        });\n\n        // Clear and destroy the canvas copy\n        canvasCopy = null;\n      };\n      if (isVideo) {\n        imgData = 'data:image/png;base64,' + self.videoFeed.getImgData();\n        image.src = imgData;\n      } else {\n        var currentWindow = options.externalWindow ? options.externalWindow : window;\n        image.src = currentWindow.getComputedStyle(self.parent)['background-image'].replace(/url\\(\"|\"\\)/g, '');\n      }\n    };\n    this.onScreenCapture = function (cb) {\n      cbs.push(cb);\n    };\n\n    /**\n     * Set flags for sharing with mobile devices\n     * @param {Boolean} mobile - Is the other party using a mobile device\n     * @param {Boolean} publishing - Are we publishing our screen?\n     */\n    this.onMobileScreenShare = function (mobile, publishing) {\n      if (publishing) {\n        publishingScreenToMobileDevice = mobile;\n      } else {\n        subscribingToMobileScreen = mobile;\n      }\n    };\n    this.onResize = function () {\n      drawUpdates(updateHistory, true);\n      draw(null, true);\n    };\n    this.onClearAnnotation = function () {\n      dismissTextAnnotation();\n    };\n    /** Canvas Handling **/\n\n    function addEventListeners(el, s, fn) {\n      var evts = s.split(' ');\n      for (var i = 0, iLen = evts.length; i < iLen; i++) {\n        el.addEventListener(evts[i], fn, true);\n      }\n    }\n    function updateCanvas(event, resizeEvent) {\n      // Ensure that our canvas has been properly sized\n      if (canvas.width === 0) {\n        canvas.width = self.parent.getBoundingClientRect().width;\n      }\n      if (canvas.height === 0) {\n        canvas.height = self.parent.getBoundingClientRect().height;\n      }\n      var offsetLeft = !!resizeEvent ? event.canvas.offsetLeft : canvas.offsetLeft;\n      var offsetTop = !!resizeEvent ? event.canvas.offsetTop : canvas.offsetTop;\n      if (cobrowsing) {\n        var baseWidth = !!resizeEvent ? event.canvas.width : self.parent.clientWidth;\n        var baseHeight = !!resizeEvent ? event.canvas.height : self.parent.clientHeight;\n        var scaleX = canvas.width / baseWidth;\n        var scaleY = canvas.height / baseHeight;\n        var offsetX = event.offsetX || event.pageX - offsetLeft || event.changedTouches && event.changedTouches[0].pageX - offsetLeft;\n        var offsetY = event.offsetY || event.pageY - offsetTop || event.changedTouches && event.changedTouches[0].pageY - offsetTop;\n        var x = offsetX * scaleX;\n        var y = offsetY * scaleY;\n      } else {\n        var videoDimensions = self.videoFeed.stream.videoDimensions;\n        var scaleX = videoDimensions.width / canvas.width;\n        var scaleY = videoDimensions.height / canvas.height;\n        if (subscribingToMobileScreen) {\n          scaleX = 1;\n          scaleY = 1;\n        }\n        var offsetX = event.offsetX || event.pageX - offsetLeft || event.changedTouches && event.changedTouches[0].pageX - offsetLeft;\n        var offsetY = event.offsetY || event.pageY - offsetTop || event.changedTouches && event.changedTouches[0].pageY - offsetTop;\n        var x = offsetX * scaleX;\n        var y = offsetY * scaleY;\n      }\n      var update;\n      var selectedItem = resizeEvent ? event.selectedItem : self.selectedItem;\n      if (selectedItem) {\n        if (selectedItem.id === 'OT_pen') {\n          switch (event.type) {\n            case 'mousedown':\n            case 'touchstart':\n              client.dragging = true;\n              client.lastX = x;\n              client.lastY = y;\n              self.isStartPoint = true;\n              !resizeEvent && _log(_logEventData.actionStartDrawing, _logEventData.variationSuccess);\n              break;\n            case 'mousemove':\n            case 'touchmove':\n              if (client.dragging) {\n                update = {\n                  id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n                  fromId: self.session.connection.connectionId,\n                  fromX: client._lastX,\n                  fromY: client._lastY,\n                  toX: x,\n                  toY: y,\n                  color: resizeEvent ? event.userColor : self.userColor,\n                  lineWidth: self.lineWidth,\n                  videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n                  videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n                  canvasWidth: canvas.width,\n                  canvasHeight: canvas.height,\n                  mirrored: mirrored,\n                  startPoint: self.isStartPoint,\n                  // Each segment is treated as a new set of points\n                  endPoint: false,\n                  selectedItem: selectedItem,\n                  platform: 'web',\n                  guid: event.guid\n                };\n                draw(new VideoRelativeCoordinateSet(update), true);\n                client.lastX = x;\n                client.lastY = y;\n                !resizeEvent && sendUpdate(update);\n                self.isStartPoint = false;\n              }\n              break;\n            case 'mouseup':\n            case 'touchend':\n              client.dragging = false;\n              update = {\n                id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n                fromId: self.session.connection.connectionId,\n                fromX: client._lastX,\n                fromY: client._lastY,\n                toX: x,\n                toY: y,\n                color: resizeEvent ? event.userColor : self.userColor,\n                lineWidth: self.lineWidth,\n                videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n                videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n                canvasWidth: canvas.width,\n                canvasHeight: canvas.height,\n                mirrored: mirrored,\n                startPoint: self.isStartPoint,\n                // Each segment is treated as a new set of points\n                endPoint: true,\n                selectedItem: selectedItem,\n                platform: 'web',\n                guid: event.guid\n              };\n              draw(new VideoRelativeCoordinateSet(update), true);\n              client.lastX = x;\n              client.lastY = y;\n              !resizeEvent && sendUpdate(update);\n              self.isStartPoint = false;\n              !resizeEvent && _log(_logEventData.actionEndDrawing, _logEventData.variationSuccess);\n              break;\n            case 'mouseout':\n              client.dragging = false;\n          }\n        } else if (selectedItem.id === 'OT_text') {\n          update = {\n            id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n            fromId: self.session.connection.connectionId,\n            fromX: x,\n            fromY: y + event.inputHeight,\n            // Account for the height of the text input\n            color: event.userColor,\n            font: event.font,\n            text: event.text,\n            videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n            videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n            canvasWidth: canvas.width,\n            canvasHeight: canvas.height,\n            mirrored: mirrored,\n            selectedItem: selectedItem,\n            platform: 'web',\n            guid: event.guid\n          };\n          draw(new VideoRelativeCoordinateSet(update));\n          !resizeEvent && sendUpdate(update);\n        } else {\n          // We have a shape or custom object\n\n          // We are currently using a constant default width for shapes\n          var shapeLineWidth = 2;\n          if (selectedItem && selectedItem.points) {\n            client.mX = x;\n            client.mY = y;\n            switch (event.type) {\n              case 'mousedown':\n              case 'touchstart':\n                client.isDrawing = true;\n                client.dragging = true;\n                client.startX = x;\n                client.startY = y;\n                break;\n              case 'mousemove':\n              case 'touchmove':\n                if (client.dragging) {\n                  update = {\n                    color: resizeEvent ? event.userColor : self.userColor,\n                    lineWidth: resizeEvent ? event.lineWidth : shapeLineWidth,\n                    selectedItem: selectedItem\n                    // INFO The points for scaling will get added when drawing is complete\n                  };\n                  draw(new VideoRelativeCoordinateSet(update), true);\n                }\n                break;\n              case 'mouseup':\n              case 'touchend':\n                client.isDrawing = false;\n                var points = selectedItem.points;\n                if (points.length === 2) {\n                  update = {\n                    id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n                    fromId: self.session.connection.connectionId,\n                    fromX: client._startX,\n                    fromY: client._startY,\n                    toX: client._mX,\n                    toY: client._mY,\n                    color: resizeEvent ? event.userColor : self.userColor,\n                    lineWidth: resizeEvent ? event.lineWidth : shapeLineWidth,\n                    videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n                    videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n                    canvasWidth: canvas.width,\n                    canvasHeight: canvas.height,\n                    mirrored: mirrored,\n                    smoothed: false,\n                    startPoint: true,\n                    selectedItem: selectedItem,\n                    platform: 'web',\n                    guid: event.guid\n                  };\n                  drawHistory.push(new VideoRelativeCoordinateSet(update));\n                  !resizeEvent && sendUpdate(update);\n                } else {\n                  var scale = scaleForPoints(points);\n                  for (var i = 0; i < points.length; i++) {\n                    var firstPoint = false;\n                    var endPoint = false;\n\n                    // Scale the points according to the difference between the start and end points\n                    var pointX = client._startX + scale.x * points[i][0];\n                    var pointY = client._startY + scale.y * points[i][1];\n                    if (i === 0) {\n                      client.lastX = pointX;\n                      client.lastY = pointY;\n                      firstPoint = true;\n                    } else if (i === points.length - 1) {\n                      endPoint = true;\n                    }\n                    update = {\n                      id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n                      fromId: self.session.connection.connectionId,\n                      fromX: client._lastX,\n                      fromY: client._lastY,\n                      toX: pointX,\n                      toY: pointY,\n                      color: resizeEvent ? event.userColor : self.userColor,\n                      lineWidth: resizeEvent ? event.lineWidth : shapeLineWidth,\n                      videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n                      videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n                      canvasWidth: canvas.width,\n                      canvasHeight: canvas.height,\n                      mirrored: mirrored,\n                      smoothed: selectedItem.enableSmoothing,\n                      startPoint: firstPoint,\n                      endPoint: endPoint,\n                      selectedItem: selectedItem,\n                      platform: 'web',\n                      guid: event.guid\n                    };\n                    drawHistory.push(new VideoRelativeCoordinateSet(update));\n                    !resizeEvent && sendUpdate(update);\n                    client.lastX = pointX; // SCALE BACK!\n                    client.lastY = pointY;\n                  }\n                  draw(null);\n                }\n                client.dragging = false;\n            }\n          }\n        }\n      }\n    }\n    function guid() {\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n        var r = Math.random() * 16 | 0,\n          v = c == 'x' ? r : r & 0x3 | 0x8;\n        return v.toString(16);\n      });\n    }\n    addEventListeners(canvas, 'mousedown mousemove mouseup mouseout touchstart touchmove touchend', function (event) {\n      // Handle text annotation separately and ignore mouse movements if we're not dragging.\n      var istextEvent = self.selectedItem && self.selectedItem.id === 'OT_text';\n      var notDragging = event.type === 'mousemove' && !client.dragging;\n      if (istextEvent || notDragging) {\n        return;\n      }\n      event.preventDefault();\n\n      // Save raw events to reprocess on canvas resize\n      event.selectedItem = self.selectedItem;\n      if (event.selectedItem) {\n        event.canvas = {\n          width: canvas.width,\n          height: canvas.height,\n          offsetLeft: canvas.offsetLeft,\n          offsetTop: canvas.offsetTop\n        };\n        event.userColor = self.userColor;\n        event.lineWidth = self.lineWidth;\n        event.guid = guid();\n        eventHistory.push(event);\n      }\n      updateCanvas(event);\n    });\n\n    /**\n     * We need intermediate event handling for text annotation since the user is adding\n     * text to an input element before it is actually added to the canvas.  The original\n     * click event is assigned to textEvent, which is then updated before being passed\n     * to updateCanvas.\n     */\n\n    /** Listen for a click on the canvas.  When it occurs, append a text input\n     * that the user can edit and listen for keydown on the enter key. When enter is\n     * pressed, processTextEvent is called, the input element is removed, and the text\n     * is appended to the canvas.\n     */\n    var textEvent;\n    var textInputId = 'textAnnotation';\n    var commitPopId = 'commitTextPop';\n    var commitPopClickId = 'confirm-btn';\n    var dismissPopId = 'dismiss-btn';\n    var ignoreClicks = false;\n    var handleClick = function (event) {\n      event.preventDefault();\n      if (!self.selectedItem || self.selectedItem.id !== 'OT_text' || ignoreClicks) {\n        return;\n      }\n      ignoreClicks = true;\n\n      // Save raw events to reprocess on canvas resize\n      event.selectedItem = self.selectedItem;\n      createTextInput(event);\n    };\n\n    /**\n     * Get the value of the text input and use it to create an \"event\".\n     */\n    var processTextEvent = function () {\n      var textInput = context.getElementById(textInputId);\n      var inputheight = textInput.clientHeight;\n      if (!textInput.value) {\n        textEvent = null;\n        return;\n      }\n      textEvent.text = textInput.value;\n      textEvent.font = '16px Arial';\n      textEvent.userColor = self.userColor;\n      textEvent.canvas = {\n        width: canvas.width,\n        height: canvas.height,\n        offsetLeft: canvas.offsetLeft,\n        offsetTop: canvas.offsetTop\n      };\n      eventHistory.push(textEvent);\n      updateCanvas(textEvent);\n      dismissTextAnnotation();\n      ignoreClicks = false;\n    };\n    var createTextInput = function (event) {\n      var textInput = context.createElement('input');\n      textInput.setAttribute('type', 'text');\n      textInput.style.position = 'fixed';\n      textInput.style.top = event.clientY + 'px';\n      textInput.style.left = event.clientX + 'px';\n      textInput.style.background = 'rgba(255,255,255, .5)';\n      textInput.style.width = '100px';\n      textInput.style.maxWidth = '200px';\n      textInput.style.border = '1px dashed red';\n      textInput.style.fontSize = '16px';\n      textInput.style.color = self.userColor;\n      textInput.style.fontFamily = 'Arial';\n      textInput.style.zIndex = '1001';\n      textInput.setAttribute('data-canvas-origin', JSON.stringify({\n        x: event.offsetX,\n        y: event.offsetY\n      }));\n      textInput.setAttribute('data-top', event.clientY - 50);\n      textInput.id = textInputId;\n      context.body.appendChild(textInput);\n      textInput.focus();\n      textInput.addEventListener('keydown', function (event) {\n        //If its Enter\n        if (event.which === 13) {\n          creteCommitPop(textInput);\n        }\n      });\n      textInput.addEventListener('blur', function () {\n        creteCommitPop(textInput);\n      });\n      textEvent = event;\n      textEvent.inputHeight = textInput.clientHeight;\n      ignoreClicks = true;\n    };\n    var creteCommitPop = function (textInput) {\n      if (context.getElementById(commitPopId)) return;\n      var commitPop = context.createElement('div');\n      commitPop.style.position = 'fixed';\n      commitPop.style.top = textInput.dataset.top + 'px';\n      commitPop.style.left = textInput.style.left;\n      commitPop.style.width = '200px';\n      commitPop.style.fontSize = '16px';\n      commitPop.style.fontFamily = 'Arial';\n      commitPop.style.zIndex = '2000';\n      commitPop.style.border = '1px solid grey';\n      commitPop.style.height = '40px';\n      commitPop.className = 'ots-annotation-prompt';\n      commitPop.id = commitPopId;\n      var commitPopText = context.createElement('span');\n      var text = context.createTextNode('Commit type?');\n      commitPopText.appendChild(text);\n      commitPop.append(commitPopText);\n      var commitPopClick = context.createElement('div');\n      commitPopClick.id = commitPopClickId;\n      commitPopClick.className = commitPopClickId;\n      var dismissDiv = context.createElement('div');\n      dismissDiv.id = dismissPopId;\n      dismissDiv.className = dismissPopId;\n      commitPop.appendChild(commitPopClick);\n      commitPop.appendChild(dismissDiv);\n      context.body.appendChild(commitPop);\n      dismissDiv.addEventListener('click', dismissTextAnnotation);\n      commitPopClick.addEventListener('click', function () {\n        processTextEvent();\n      });\n    };\n    var dismissTextAnnotation = function () {\n      if (context.getElementById(textInputId)) context.getElementById(textInputId).remove();\n      if (context.getElementById(commitPopId)) context.getElementById(commitPopId).remove();\n      textEvent = null;\n      ignoreClicks = false;\n    };\n    addEventListeners(canvas, 'click', handleClick);\n\n    /**\n     * End Handle text markup\n     */\n\n    var draw = function (update, resizeEvent) {\n      if (!ctx) {\n        ctx = canvas.getContext('2d');\n        ctx.lineCap = 'round';\n        ctx.lineJoin = 'round';\n        ctx.fillStyle = 'solid';\n      }\n\n      // Clear the canvas\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n      // Repopulate the canvas with items from drawHistory\n      drawHistory.forEach(function (history) {\n        ctx.strokeStyle = history.color;\n        ctx.lineWidth = history.lineWidth;\n\n        // INFO iOS serializes bools as 0 or 1\n        history.smoothed = !!history.smoothed;\n        history.startPoint = !!history.startPoint;\n        var secondPoint = false;\n        var isText = history.hasOwnProperty('text');\n        if (isText) {\n          ctx.font = history.font;\n          ctx.fillStyle = history.color;\n          ctx.fillText(history.text, history.fromX, history.fromY);\n        } else {\n          if (history.smoothed) {\n            if (history.startPoint) {\n              self.isStartPoint = true;\n            } else {\n              // If the start point flag was already set, we received the next point in the sequence\n              if (self.isStartPoint) {\n                secondPoint = true;\n                self.isStartPoint = false;\n              }\n            }\n            if (history.startPoint) {\n              // Close the last path and create a new one\n              ctx.closePath();\n              ctx.beginPath();\n            } else if (secondPoint) {\n              ctx.moveTo((history.fromX + history.toX) / 2, (history.fromY + history.toY) / 2);\n            } else {\n              // console.log('Points: (' + (history.fromX + history.toX) / 2 + ', ' + (history.fromY + history.toY) / 2 + ')');\n              // console.log('Control Points: (' + history.fromX + ', ' + history.fromY + ')');\n              ctx.quadraticCurveTo(history.fromX, history.fromY, (history.fromX + history.toX) / 2, (history.fromY + history.toY) / 2);\n              ctx.stroke();\n            }\n          } else {\n            ctx.beginPath();\n            ctx.moveTo(history.fromX, history.fromY);\n            ctx.lineTo(history.toX, history.toY);\n            ctx.stroke();\n            ctx.closePath();\n          }\n        }\n      });\n      if (!!resizeEvent && !update) {\n        return;\n      }\n      var selectedItem = !!resizeEvent ? update.selectedItem : self.selectedItem;\n      if (selectedItem && (selectedItem.title === 'Pen' || selectedItem.title === 'Text')) {\n        if (update) {\n          if (selectedItem.title === 'Pen') {\n            ctx.strokeStyle = update.color;\n            ctx.lineWidth = update.lineWidth;\n            ctx.beginPath();\n            ctx.moveTo(update.fromX, update.fromY);\n            ctx.lineTo(update.toX, update.toY);\n            ctx.stroke();\n            ctx.closePath();\n          }\n          if (selectedItem.title === 'Text') {\n            ctx.font = update.font;\n            ctx.fillStyle = update.color;\n            ctx.fillText(update.text, update.fromX, update.fromY);\n          }\n          drawHistory.push(update);\n        }\n      } else {\n        if (client.isDrawing) {\n          if (update) {\n            ctx.strokeStyle = update.color;\n            ctx.lineWidth = update.lineWidth;\n          }\n          if (selectedItem && selectedItem.points) {\n            drawPoints(ctx, self.selectedItem.points);\n          }\n        }\n      }\n    };\n    var drawPoints = function (ctx, points) {\n      var scale = scaleForPoints(points);\n      ctx.beginPath();\n      if (points.length === 2) {\n        // We have a line\n        ctx.moveTo(client.startX, client.startY);\n        ctx.lineTo(client.mX, client.mY);\n      } else {\n        for (var i = 0; i < points.length; i++) {\n          // Scale the points according to the difference between the start and end points\n          // Use device independent points here!\n          client.pointX = client._startX + scale.x * points[i][0];\n          client.pointY = client._startY + scale.y * points[i][1];\n          if (self.selectedItem.enableSmoothing) {\n            if (i === 0) {\n              // Do nothing\n            } else if (i === 1) {\n              ctx.moveTo((client.pointX + client.lastX) / 2, (client.pointY + client.lastY) / 2);\n              client.lastX = (client._pointX + client._lastX) / 2;\n              client.lastX = (client._pointY + client._lastY) / 2;\n            } else {\n              ctx.quadraticCurveTo(client.lastX, client.lastY, (client.pointX + client.lastX) / 2, (client.pointY + client.lastY) / 2);\n              client.lastX = (client._pointX + client._lastX) / 2;\n              client.lastY = (client._pointY + client._lastY) / 2;\n            }\n          } else {\n            if (i === 0) {\n              ctx.moveTo(client.pointX, client.pointY);\n            } else {\n              ctx.lineTo(client.pointX, client.pointY);\n            }\n          }\n          client.lastX = client._pointX; // SCALE BACK!\n          client.lastY = client._pointY;\n        }\n      }\n      ctx.stroke();\n      ctx.closePath();\n    };\n    var scaleForPoints = function (points) {\n      // mX and mY refer to the end point of the enclosing rectangle (touch up)\n      var minX = Number.MAX_VALUE;\n      var minY = Number.MAX_VALUE;\n      var maxX = 0;\n      var maxY = 0;\n      for (var i = 0; i < points.length; i++) {\n        if (points[i][0] < minX) {\n          minX = points[i][0];\n        } else if (points[i][0] > maxX) {\n          maxX = points[i][0];\n        }\n        if (points[i][1] < minY) {\n          minY = points[i][1];\n        } else if (points[i][1] > maxY) {\n          maxY = points[i][1];\n        }\n      }\n      var dx = Math.abs(maxX - minX);\n      var dy = Math.abs(maxY - minY);\n      var scaleX = (client._mX - client._startX) / dx;\n      var scaleY = (client._mY - client._startY) / dy;\n      return {\n        x: scaleX,\n        y: scaleY\n      };\n    };\n    var drawIncoming = function (update, resizeEvent, index) {\n      var iCanvas = {\n        width: update.canvasWidth,\n        height: update.canvasHeight\n      };\n      var iVideo = {\n        width: update.videoWidth,\n        height: update.videoHeight\n      };\n      var video = {\n        width: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n        height: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height\n      };\n\n      // INFO iOS serializes bools as 0 or 1\n      update.mirrored = !!update.mirrored;\n\n      // Check if the incoming signal was mirrored\n      if (update.mirrored) {\n        update.fromX = video.width - update.fromX;\n        update.toX = video.width - update.toX;\n      }\n\n      // Check to see if the active video feed is also mirrored (double negative)\n      if (mirrored) {\n        // Revert (Double negative)\n        update.fromX = video.width - update.fromX;\n        update.toX = video.width - update.toX;\n      }\n\n      /** Keep history of updates for resize */\n      var updateForHistory = JSON.parse(JSON.stringify(update));\n      updateForHistory.canvasWidth = canvas.width;\n      updateForHistory.canvasHeight = canvas.height;\n      updateForHistory.videoWidth = video.width;\n      updateForHistory.videoHeight = video.height;\n      if (resizeEvent) {\n        updateHistory[index] = updateForHistory;\n      } else {\n        updateHistory.push(updateForHistory);\n        drawHistory.push(new VideoRelativeCoordinateSet(update));\n      }\n      /** ********************************** */\n\n      draw(null);\n    };\n    var drawUpdates = function (updates, resizeEvent) {\n      updates.forEach(function (update, index) {\n        if (!isVideo || self.videoFeed && self.videoFeed.stream && update.id === self.videoFeed.stream.connection.connectionId) {\n          drawIncoming(update, resizeEvent, index);\n        }\n      });\n    };\n    var clearCanvas = function (incoming, cid) {\n      // console.log('cid: ' + cid);\n      // Remove all elements from history that were drawn by the sender\n\n      drawHistory = drawHistory.filter(function (history) {\n        return history.fromId !== cid;\n      });\n      if (!incoming) {\n        if (self.session) {\n          self.session.signal({\n            type: 'otAnnotation_clear'\n          });\n        }\n        eventHistory = [];\n      } else {\n        updateHistory = [];\n      }\n\n      // Refresh the canvas\n      draw();\n    };\n    var undoLast = function (incoming, cid, itemsToRemove) {\n      var historyItem;\n      var removed;\n      var endPoint = false;\n      var removedItems = [];\n      for (var i = drawHistory.length - 1; i >= 0; i--) {\n        historyItem = drawHistory[i];\n        if (historyItem.fromId === cid) {\n          if (historyItem.platform === 'ios' && !!itemsToRemove && !!itemsToRemove.length && itemsToRemove[0] !== null) {\n            undoLastIos(incoming, cid, itemsToRemove);\n            break;\n          }\n          endPoint = endPoint || historyItem.endPoint;\n          removed = drawHistory.splice(i, 1)[0];\n          removedItems.push(removed.guid);\n          if (!endPoint || endPoint && removed.startPoint === true) {\n            break;\n          }\n        }\n      }\n      if (incoming) {\n        updateHistory = updateHistory.filter(function (history) {\n          return !itemsToRemove.includes(history.guid);\n        });\n      } else {\n        eventHistory = eventHistory.filter(function (history) {\n          return !removedItems.includes(history.guid);\n        });\n        self.session.signal({\n          type: 'otAnnotation_undo',\n          data: JSON.stringify(removedItems)\n        });\n      }\n      draw();\n    };\n    var undoLastIos = function (incoming, cid, itemsToRemove) {\n      var historyItem;\n      var removed;\n      var endPoint = false;\n      var removedItems = [];\n      for (var i = drawHistory.length - 1; i >= 0; i--) {\n        historyItem = drawHistory[i];\n        if (historyItem.fromId === cid) {\n          if (historyItem.guid === itemsToRemove[0]) {\n            removed = drawHistory.splice(i, 1)[0];\n            removedItems.push(removed.guid);\n          }\n        }\n      }\n      if (incoming) {\n        updateHistory = updateHistory.filter(function (history) {\n          return !itemsToRemove.includes(history.guid);\n        });\n      } else {\n        eventHistory = eventHistory.filter(function (history) {\n          return !removedItems.includes(history.guid);\n        });\n        self.session.signal({\n          type: 'otAnnotation_undo',\n          data: JSON.stringify(removedItems)\n        });\n      }\n      draw();\n    };\n    var count = 0;\n    /** Signal Handling **/\n    if (_session) {\n      _session.on({\n        'signal:otAnnotation_pen': function (event) {\n          if (event.from.connectionId !== _session.connection.connectionId) {\n            var paths = JSON.parse(event.data);\n            drawUpdates(paths);\n          }\n        },\n        'signal:otAnnotation_text': function (event) {\n          if (event.from.connectionId !== _session.connection.connectionId) {\n            drawUpdates(JSON.parse(event.data));\n          }\n        },\n        'signal:otAnnotation_history': function (event) {\n          // We will receive these from everyone in the room, only listen to the first\n          // person. Also the data is chunked together so we need all of that person's\n          if (!drawHistoryReceivedFrom || drawHistoryReceivedFrom === event.from.connectionId) {\n            drawHistoryReceivedFrom = event.from.connectionId;\n            drawUpdates(JSON.parse(event.data));\n          }\n        },\n        'signal:otAnnotation_clear': function (event) {\n          if (event.from.connectionId !== _session.connection.connectionId) {\n            // Only clear elements drawn by the sender's (from) Id\n            clearCanvas(true, event.from.connectionId);\n          }\n        },\n        'signal:otAnnotation_undo': function (event) {\n          if (event.from.connectionId !== _session.connection.connectionId) {\n            // Only clear elements drawn by the sender's (from) Id\n            undoLast(true, event.from.connectionId, JSON.parse(event.data));\n          }\n        },\n        connectionCreated: function (event) {\n          if (drawHistory.length > 0 && event.connection.connectionId !== _session.connection.connectionId) {\n            batchSignal('otWhiteboard_history', drawHistory, event.connection);\n          }\n        }\n      });\n    }\n    var batchSignal = function (data, toConnection) {\n      var signalError = function (err) {\n        if (err) {\n          TB.error(err);\n        }\n      };\n      var type = 'otAnnotation_pen';\n      var updateType = function (chunk) {\n        if (!chunk || !chunk[0] || !chunk[0].selectedItem || !chunk[0].selectedItem.id) {\n          return;\n        }\n        var id = chunk[0].selectedItem.id;\n        type = id === 'OT_text' ? 'otAnnotation_text' : 'otAnnotation_pen';\n      };\n\n      /**\n       * If the 'type' string exceeds the maximum length (128 bytes), or the\n       * 'data' string exceeds the maximum size (8 kB), OT will return a 413 error\n       * and the signal will not be sent.  The maximum number of characters that\n       * can be sent in the signal is 8,192.  Currently, the largest updates are\n       * 995 characters, meaning that the limit for the number of updates per\n       * signal should be 8, even taking into account the additional characters\n       * required to convert the entire array of updates as opposed to each one\n       * individually.  However, OT is throwing a 413 error once the size exceeds\n       * 7,900 characters. So, 7 is the magic number for the time being.\n       * UPDATE: At 7, we're still seeing errors.  So, 6 it is.\n       */\n      var dataChunk;\n      var start = 0;\n      var updatesPerSignal = 6;\n      while (start < data.length) {\n        dataChunk = data.slice(start, start + updatesPerSignal);\n        updateType(dataChunk);\n        start += updatesPerSignal;\n        var signal = {\n          type: type,\n          data: JSON.stringify(dataChunk)\n        };\n        if (toConnection) {\n          signal.to = toConnection;\n        }\n        self.session.signal(signal, signalError);\n      }\n    };\n    var updateTimeout;\n    var sendUpdate = function (update) {\n      if (self.session) {\n        batchUpdates.push(update);\n        if (!updateTimeout) {\n          updateTimeout = setTimeout(function () {\n            batchSignal(batchUpdates);\n            batchUpdates = [];\n            updateTimeout = null;\n          }, 100);\n        }\n      }\n    };\n  };\n\n  //--------------------------------------\n  //  OPENTOK ANNOTATION TOOLBAR\n  //--------------------------------------\n\n  OTSolution.Annotations.Toolbar = function (options) {\n    var self = this;\n    var _toolbar = this;\n    options || (options = {});\n    if (!options.session) {\n      throw new Error('OpenTok Annotation Widget requires an OpenTok session');\n    } else {\n      _session = options.session;\n    }\n    if (!_OTKAnalytics && !options.OTKAnalytics) {\n      throw new Error('OpenTok Annotation Widget requires an OpenTok Solution');\n    } else {\n      _OTKAnalytics = _OTKAnalytics || options.OTKAnalytics;\n    }\n    if (!_otkanalytics) {\n      _logAnalytics();\n    }\n    this.session = options.session;\n    this.parent = options.container;\n    this.externalWindow = options.externalWindow;\n    // TODO Allow 'style' objects to be passed in for buttons, menu toolbar, etc?\n    this.backgroundColor = options.backgroundColor || 'rgba(102, 102, 102, 0.90)';\n    this.subpanelBackgroundColor = options.subpanelBackgroundColor || '#323232';\n    var imageAssets = options.imageAssets || DEFAULT_ASSET_URL;\n    var toolbarItems = [{\n      id: 'OT_pen',\n      title: 'Pen',\n      icon: [imageAssets, 'annotation-pencil.png'].join(''),\n      selectedIcon: [imageAssets, 'annotation-pencil.png'].join(''),\n      items: {/* Built dynamically */}\n    }, {\n      id: 'OT_colors',\n      title: 'Colors',\n      icon: '',\n      items: {/* Built dynamically */}\n    }, {\n      id: 'OT_shapes',\n      title: 'Shapes',\n      icon: [imageAssets, 'annotation-shapes.png'].join(''),\n      items: [{\n        id: 'OT_rect',\n        title: 'Rectangle',\n        icon: [imageAssets, 'annotation-rectangle.png'].join(''),\n        points: [[0, 0], [1, 0], [1, 1], [0, 1], [0, 0] // Reconnect point\n        ]\n      }, {\n        id: 'OT_rect_fill',\n        title: 'Rectangle-Fill',\n        icon: [imageAssets, 'annotation-rectangle.png'].join(''),\n        points: [[0, 0], [1, 0], [1, 1], [0, 1], [0, 0] // Reconnect point\n        ]\n      }, {\n        id: 'OT_oval',\n        title: 'Oval',\n        icon: [imageAssets, 'annotation-oval.png'].join(''),\n        enableSmoothing: true,\n        points: [[0, 0.5], [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)], [0.5, 0], [0.5 + 0.5 * Math.cos(7 * Math.PI / 4), 0.5 + 0.5 * Math.sin(7 * Math.PI / 4)], [1, 0.5], [0.5 + 0.5 * Math.cos(Math.PI / 4), 0.5 + 0.5 * Math.sin(Math.PI / 4)], [0.5, 1], [0.5 + 0.5 * Math.cos(3 * Math.PI / 4), 0.5 + 0.5 * Math.sin(3 * Math.PI / 4)], [0, 0.5], [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)]]\n      }, {\n        id: 'OT_oval_fill',\n        title: 'Oval-Fill',\n        icon: [imageAssets, 'annotation-oval-fill.png'].join(''),\n        enableSmoothing: true,\n        points: [[0, 0.5], [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)], [0.5, 0], [0.5 + 0.5 * Math.cos(7 * Math.PI / 4), 0.5 + 0.5 * Math.sin(7 * Math.PI / 4)], [1, 0.5], [0.5 + 0.5 * Math.cos(Math.PI / 4), 0.5 + 0.5 * Math.sin(Math.PI / 4)], [0.5, 1], [0.5 + 0.5 * Math.cos(3 * Math.PI / 4), 0.5 + 0.5 * Math.sin(3 * Math.PI / 4)], [0, 0.5], [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)]]\n      }, {\n        id: 'OT_star',\n        title: 'Star',\n        icon: [imageAssets, 'annotation-star.png'].join(''),\n        points: [/* eslint-disable max-len */\n        [0.5 + 0.5 * Math.cos(90 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(90 * (Math.PI / 180))], [0.5 + 0.25 * Math.cos(126 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(126 * (Math.PI / 180))], [0.5 + 0.5 * Math.cos(162 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(162 * (Math.PI / 180))], [0.5 + 0.25 * Math.cos(198 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(198 * (Math.PI / 180))], [0.5 + 0.5 * Math.cos(234 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(234 * (Math.PI / 180))], [0.5 + 0.25 * Math.cos(270 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(270 * (Math.PI / 180))], [0.5 + 0.5 * Math.cos(306 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(306 * (Math.PI / 180))], [0.5 + 0.25 * Math.cos(342 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(342 * (Math.PI / 180))], [0.5 + 0.5 * Math.cos(18 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(18 * (Math.PI / 180))], [0.5 + 0.25 * Math.cos(54 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(54 * (Math.PI / 180))], [0.5 + 0.5 * Math.cos(90 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(90 * (Math.PI / 180))]\n        /* eslint-enable max-len */]\n      }, {\n        id: 'OT_arrow',\n        title: 'Arrow',\n        icon: [imageAssets, 'annotation-arrow.png'].join(''),\n        points: [[0, 1], [3, 1], [3, 0], [5, 2], [3, 4], [3, 3], [0, 3], [0, 1] // Reconnect point\n        ]\n      }, {\n        id: 'OT_line',\n        title: 'Line',\n        icon: [imageAssets, 'annotation-line.png'].join(''),\n        selectedIcon: [imageAssets, 'annotation-line.png'].join(''),\n        points: [[0, 0], [0, 1]]\n      }]\n    }, {\n      id: 'OT_text',\n      title: 'Text',\n      icon: [imageAssets, 'annotation-text.png'].join(''),\n      selectedIcon: [imageAssets, 'annotation-text.png'].join('')\n    }, {\n      id: 'OT_capture',\n      title: 'Capture',\n      icon: [imageAssets, 'annotation-camera.png'].join(''),\n      selectedIcon: [imageAssets, 'annotation-camera.png'].join('')\n    }, {\n      id: 'OT_undo',\n      title: 'Undo',\n      icon: [imageAssets, 'annotation-undo.png'].join('')\n    }, {\n      id: 'OT_clear',\n      title: 'Clear',\n      icon: [imageAssets, 'annotation-clear.png'].join('')\n    }];\n\n    /**\n     * If we recieve items as part of the options hash, build the toolbar from the list of items.\n     * Otherwise, include all items.\n     */\n    var getItems = function () {\n      var itemNames = ['pen', 'colors', 'shapes', 'text', 'capture', 'undo', 'clear'];\n      var shapeNames = ['rectangle', 'rectangle-fill', 'oval', 'oval-fill', 'star', 'arrow', 'line'];\n      var addItem = function (acc, item) {\n        var index = itemNames.indexOf(item);\n        if (index !== -1) {\n          var toolbarItem = toolbarItems[index];\n          if (toolbarItem.title === 'Shapes' && !!options.shapes) {\n            var shapes = options.shapes.reduce(function (shapeAcc, shape) {\n              var shapeIndex = shapeNames.indexOf(shape);\n              return shapeIndex !== -1 ? shapeAcc.concat(toolbarItem.items[shapeIndex]) : shapeAcc;\n            }, []);\n            toolbarItem.items = shapes;\n          }\n          acc.push(toolbarItem);\n        }\n        return acc;\n      };\n      if (!!options.items && !!options.items.length) {\n        var itemsToBuild = options.items[0] === '*' ? itemNames : options.items;\n        return itemsToBuild.reduce(addItem, []);\n      } else {\n        return toolbarItems;\n      }\n    };\n    this.items = getItems();\n    this.colors = options.colors || ['#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#16a085', '#27ae60', '#2980b9', '#8e44ad', '#2c3e50', '#f1c40f', '#e67e22', '#e74c3c', '#ecf0f1', '#95a5a6', '#f39c12', '#d35400', '#c0392b', '#bdc3c7', '#7f8c8d'];\n    this.cbs = [];\n    var canvases = [];\n\n    /**\n     * Creates a sub-menu with a color picker.\n     *\n     * @param {String|Element} parent The parent div container for the color picker sub-menu.\n     * @param {Array} colors The array of colors to add to the palette.\n     * @param {Object} options options An object containing the following fields:\n     *\n     *  - `openEvent` (String): The open event (default: `\"click\"`).\n     *  - `style` (Object): Some style options:\n     *    - `display` (String): The display value when the picker is opened (default: `\"block\"`).\n     *  - `template` (String): The color item template. The `{color}` snippet will be replaced\n     *    with the color value (default: `\"<div data-col=\\\"{color}\\\" style=\\\"background-color: {color}\\\"></div>\"`).\n     *  - `autoclose` (Boolean): If `false`, the color picker will not be hidden by default (default: `true`).\n     *\n     * @constructor\n     */\n    var ColorPicker = function (parent, colors, options) {\n      var self = this;\n      var context = _toolbar.externalWindow ? _toolbar.externalWindow.document : document;\n      this.getElm = function (el, all) {\n        if (typeof el === 'string') {\n          return all ? context.querySelectorAll(el) : context.querySelector(el);\n        }\n        return el;\n      };\n      this.render = function () {\n        var self = this,\n          html = '';\n        self.colors.forEach(function (c) {\n          html += self.options.template.replace(/\\{color\\}/g, c);\n        });\n        self.elm.innerHTML = html;\n      };\n      this.close = function () {\n        // this.elm.style.display = 'none';\n        this.elm.classList.add('ots-hidden');\n      };\n      this.open = function () {\n        // this.elm.style.display = this.options.style.display;\n        this.elm.classList.remove('ots-hidden');\n      };\n      this.colorChosen = function (cb) {\n        this.cbs.push(cb);\n      };\n      this.set = function (c, p) {\n        var self = this;\n        self.color = c;\n        if (p === false) {\n          return;\n        }\n        self.cbs.forEach(function (cb) {\n          cb.call(self, c);\n        });\n      };\n      options = options || {};\n      options.openEvent = options.openEvent || 'click';\n      options.style = Object(options.style);\n      // options.style.display = options.style.display || 'block';\n      options.template = options.template || '<div class=\\\"color-choice\\\" data-col=\\\"{color}\\\" style=\\\"background-color: {color}\\\"></div>';\n      self.elm = self.getElm(parent);\n      self.cbs = [];\n      self.colors = colors;\n      self.options = options;\n      self.render();\n\n      // Click on colors\n      self.elm.addEventListener('click', function (ev) {\n        var color = ev.target.getAttribute('data-col');\n        if (!color) {\n          return;\n        }\n        var colors = Array.from(self.getElm('.color-choice', true));\n        colors.forEach(function (el) {\n          el.classList.remove('active');\n        });\n        ev.target.classList.add('active');\n        self.set(color);\n        self.close();\n      });\n      if (options.autoclose !== false) {\n        self.close();\n      }\n    };\n    var panel;\n    this.createPanel = function (externalWindow) {\n      if (_toolbar.parent) {\n        var context = externalWindow ? externalWindow.document : document;\n        panel = context.createElement('div');\n        panel.setAttribute('id', 'OT_toolbar');\n        panel.setAttribute('class', 'OT_panel');\n        panel.style.width = '100%';\n        panel.style.height = '100%';\n        this.parent.appendChild(panel);\n        this.parent.style.position = 'relative';\n        this.parent.zIndex = 1000;\n        var toolbarItems = [];\n        var subPanel = context.createElement('div');\n        for (var i = 0, total = this.items.length; i < total; i++) {\n          var item = this.items[i];\n          var button = context.createElement('input');\n          button.setAttribute('type', 'button');\n          button.setAttribute('id', item.id);\n          button.classList.add('annotation-btn');\n          button.classList.add(item.title.split(' ').join('-').toLowerCase());\n          if (item.id === 'OT_colors') {\n            var colorPicker = context.createElement('div');\n            colorPicker.setAttribute('class', 'color-picker');\n            // colorPicker.style.backgroundColor = this.subpanelBackgroundColor;\n            this.parent.appendChild(colorPicker);\n            var pk = new ColorPicker('.color-picker', this.colors, {\n              externalWindow: _toolbar.externalWindow\n            });\n            pk.colorChosen(function (color) {\n              var colorGroup = context.getElementById('OT_colors');\n              colorGroup.style.backgroundColor = color;\n              canvases.forEach(function (canvas) {\n                canvas.changeColor(color);\n              });\n            });\n            var colorChoices = context.querySelectorAll('.color-choice');\n            colorChoices[0].classList.add('active');\n            button.setAttribute('class', 'OT_color annotation-btn colors');\n            button.style.borderRadius = '50%';\n            button.style.backgroundColor = this.colors[0];\n          }\n          if (item.title === 'Pen' && !Array.isArray(item.items)) {\n            // Add defaults\n            item.items = [{\n              id: 'OT_line_width_2',\n              title: 'Line Width 2',\n              size: 2\n            }, {\n              id: 'OT_line_width_4',\n              title: 'Line Width 4',\n              size: 4\n            }, {\n              id: 'OT_line_width_6',\n              title: 'Line Width 6',\n              size: 6\n            }, {\n              id: 'OT_line_width_8',\n              title: 'Line Width 8',\n              size: 8\n            }, {\n              id: 'OT_line_width_10',\n              title: 'Line Width 10',\n              size: 10\n            }, {\n              id: 'OT_line_width_12',\n              title: 'Line Width 12',\n              size: 12\n            }, {\n              id: 'OT_line_width_14',\n              title: 'Line Width 14',\n              size: 14\n            }];\n          }\n          if (item.items) {\n            // Indicate that we have a group\n            button.setAttribute('data-type', 'group');\n          }\n          button.setAttribute('data-col', item.title);\n          toolbarItems.push(button.outerHTML);\n        }\n        panel.innerHTML = toolbarItems.join('');\n\n        /**\n         * Since the color picker button uses its background to display the\n         * current color, we need to add a pseudo-element element to the toolbar\n         * to simulate hover state on the button.  When the user hovers over the\n         * button, we add the 'colors-hover' class to 'OT_toolbar' which has a\n         * pseudo-element which makes it seem as though the color picker button\n         * background is changing.\n         * TODO: Update the color picker and color choices to display colors\n         *       using pseudo-elements, so that we can more easily apply hover\n         *       states.\n         */\n        var toggleColorsHover = function (hover) {\n          var action = hover ? 'add' : 'remove';\n          document.getElementById('OT_toolbar').classList[action]('colors-hover');\n        };\n        var colors = context.getElementById('OT_colors');\n        colors.addEventListener('mouseenter', function () {\n          toggleColorsHover(true);\n        });\n        colors.addEventListener('mouseleave', function () {\n          toggleColorsHover(false);\n        });\n        /** End color picker hover state */\n\n        panel.onclick = function (ev) {\n          var group = ev.target.getAttribute('data-type') === 'group';\n          var itemName = ev.target.getAttribute('data-col');\n          var id = ev.target.getAttribute('id');\n\n          // Close the submenu if we are clicking on an item and not a group button\n          if (!group) {\n            self.items.forEach(function (item) {\n              if ((item.title !== 'Clear' || item.title !== 'Undo') && item.title === itemName) {\n                self.selectedItem = item;\n                attachDefaultAction(item);\n                canvases.forEach(function (canvas) {\n                  canvas.selectItem(self.selectedItem);\n                });\n                return false;\n              }\n            });\n            subPanel.classList.add('ots-hidden');\n          } else {\n            self.items.forEach(function (item) {\n              if (item.title === itemName) {\n                self.selectedGroup = item;\n                if (item.items) {\n                  subPanel.setAttribute('class', ['OT_subpanel', 'ots-hidden', item.title.toLowerCase()].join(' '));\n                  self.parent.appendChild(subPanel);\n                  if (Array.isArray(item.items)) {\n                    var submenuItems = [];\n                    if (item.id === 'OT_pen') {\n                      // We want to dynamically create icons for the list of possible line widths\n                      item.items.forEach(function (subItem) {\n                        // INFO Using a div here - not input to create an inner div representing the line width - better option?\n                        var itemButton = context.createElement('div');\n                        itemButton.setAttribute('data-col', subItem.title);\n                        itemButton.setAttribute('class', ['line-width-option', subItem.size].join(' '));\n                        itemButton.setAttribute('id', subItem.id);\n                        var lineIcon = context.createElement('div');\n                        lineIcon.setAttribute('class', 'line-width-icon');\n                        // TODO Allow devs to change this?\n                        lineIcon.style.backgroundColor = '#FFFFFF';\n                        lineIcon.style.width = '80%';\n                        lineIcon.style.height = subItem.size + 'px';\n                        lineIcon.style.position = 'relative';\n                        lineIcon.style.left = '50%';\n                        lineIcon.style.top = '50%';\n                        lineIcon.style.transform = 'translateX(-50%) translateY(-50%)';\n                        // Prevents div icon from catching events so they can be passed to the parent\n                        lineIcon.style.pointerEvents = 'none';\n                        itemButton.appendChild(lineIcon);\n                        submenuItems.push(itemButton.outerHTML);\n                      });\n                    } else {\n                      item.items.forEach(function (subItem) {\n                        var itemButton = context.createElement('input');\n                        itemButton.setAttribute('type', 'button');\n                        itemButton.setAttribute('data-col', subItem.title);\n                        itemButton.setAttribute('id', subItem.id);\n                        itemButton.setAttribute('class', ['annotation-btn', subItem.title.toLowerCase()].join(' '));\n                        // itemButton.style.backgroundImage = 'url(\"' + subItem.icon + '\")';\n                        // itemButton.style.position = 'relative';\n                        // itemButton.style.top = '50%';\n                        // itemButton.style.transform = 'translateY(-50%)';\n                        // itemButton.style.backgroundSize = self.iconWidth + ' ' + self.iconHeight;\n                        // itemButton.style.backgroundPosition = 'center';\n                        // itemButton.style.width = self.buttonWidth;\n                        // itemButton.style.height = self.buttonHeight;\n                        // itemButton.style.border = 'none';\n                        // itemButton.style.cursor = 'pointer';\n\n                        submenuItems.push(itemButton.outerHTML);\n                      });\n                    }\n                    subPanel.innerHTML = submenuItems.join('');\n                  }\n                }\n                if (id === 'OT_shapes' || id === 'OT_pen') {\n                  if (subPanel) {\n                    subPanel.classList.remove('ots-hidden');\n                  }\n                  pk.close();\n                } else if (id === 'OT_colors') {\n                  if (subPanel) {\n                    subPanel.classList.add('ots-hidden');\n                  }\n                  pk.open();\n                }\n              }\n            });\n          }\n          self.cbs.forEach(function (cb) {\n            cb.call(self, id);\n          });\n        };\n        subPanel.onclick = function (ev) {\n          var group = ev.target.getAttribute('data-type') === 'group';\n          var itemName = ev.target.getAttribute('data-col');\n          var id = ev.target.getAttribute('id');\n          if (!!id && id.replace(/[^a-z]/g, '') === 'linewidth') {\n            canvases.forEach(function (canvas) {\n              canvas.selectItem(self.selectedGroup);\n            });\n          }\n          subPanel.classList.add('ots-hidden');\n          if (!group) {\n            self.selectedGroup.items.forEach(function (item) {\n              if (item.id !== 'OT_clear' && item.id === id) {\n                if (self.selectedItem) {\n                  var lastBtn = document.getElementById(self.selectedItem.id);\n                  if (lastBtn) {\n                    // lastBtn.style.background = 'url(\"' + self.selectedItem.icon + '\") no-repeat';\n                    // lastBtn.style.backgroundSize = self.iconWidth + ' ' + self.iconHeight;\n                    // lastBtn.style.backgroundPosition = 'center';\n                  }\n                }\n                if (item.selectedIcon) {\n                  var selBtn = document.getElementById(item.id);\n                  if (lastBtn) {\n                    selBtn.style.background = 'url(\"' + item.selectedIcon + '\") no-repeat';\n                    selBtn.style.backgroundSize = self.iconWidth + ' ' + self.iconHeight;\n                    selBtn.style.backgroundPosition = 'center';\n                  }\n                }\n                self.selectedItem = item;\n                attachDefaultAction(item);\n                canvases.forEach(function (canvas) {\n                  canvas.selectItem(self.selectedItem);\n                });\n                return false;\n              }\n            });\n          }\n          self.cbs.forEach(function (cb) {\n            cb.call(self, id);\n          });\n        };\n        var onClear = context.getElementById('OT_clear').onclick = function () {\n          canvases.forEach(function (canvas) {\n            canvas.clear();\n          });\n        };\n        context.getElementById('OT_undo').onclick = function () {\n          canvases.forEach(function (canvas) {\n            canvas.undo();\n          });\n        };\n        window.addEventListener('OT_clear', function () {\n          onClear();\n          self.selectedItem = null;\n          canvases.forEach(function (canvas) {\n            canvas.selectItem(self.selectedItem);\n          });\n        });\n        window.addEventListener('OT_pen', function (evt) {\n          var item = self.items.find(function (item) {\n            return item.id === 'OT_pen';\n          });\n          self.selectedItem = item;\n          attachDefaultAction(item);\n          var color = evt.detail.color;\n          canvases.forEach(function (canvas) {\n            canvas.selectItem(self.selectedItem);\n            color && canvas.changeColor(color);\n          });\n        });\n      }\n    };\n    !this.externalWindow && this.createPanel();\n    var attachDefaultAction = function (item) {\n      if (!item.points) {\n        // Attach default actions\n        if (item.id === 'OT_line') {\n          self.selectedItem.points = [[0, 0], [0, 1]];\n        } else if (item.id === 'OT_arrow') {\n          self.selectedItem.points = [[0, 1], [3, 1], [3, 0], [5, 2], [3, 4], [3, 3], [0, 3], [0, 1] // Reconnect point\n          ];\n        } else if (item.id === 'OT_rect') {\n          self.selectedItem.points = [[0, 0], [1, 0], [1, 1], [0, 1], [0, 0] // Reconnect point\n          ];\n        } else if (item.id === 'OT_oval') {\n          self.selectedItem.enableSmoothing = true;\n          self.selectedItem.points = [[0, 0.5], [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)], [0.5, 0], [0.5 + 0.5 * Math.cos(7 * Math.PI / 4), 0.5 + 0.5 * Math.sin(7 * Math.PI / 4)], [1, 0.5], [0.5 + 0.5 * Math.cos(Math.PI / 4), 0.5 + 0.5 * Math.sin(Math.PI / 4)], [0.5, 1], [0.5 + 0.5 * Math.cos(3 * Math.PI / 4), 0.5 + 0.5 * Math.sin(3 * Math.PI / 4)], [0, 0.5], [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)]];\n        }\n      }\n    };\n\n    /**\n     * Callback function for toolbar menu item click events.\n     * @param cb The callback function used to handle the click event.\n     */\n    this.itemClicked = function (cb) {\n      this.cbs.push(cb);\n    };\n\n    /**\n     * Links an annotation canvas to the toolbar so that menu actions can be handled on it.\n     * @param canvas The annotation canvas to be linked to the toolbar.\n     * @param externalWindow External screen sharing window\n     */\n    this.addCanvas = function (canvas, externalWindow) {\n      var self = this;\n      var context = externalWindow ? externalWindow.document : document;\n      canvas.link(self.session);\n      canvas.colors(self.colors);\n      canvases.push(canvas);\n      canvases.forEach(function (canvas) {\n        canvas.selectedItem = canvas.selectedItem || self.items[0];\n        context.getElementById(canvas.selectedItem.id).classList.add('selected');\n      });\n    };\n\n    /**\n     * Removes the annotation canvas with the specified connectionId from its parent container and\n     * unlinks it from the toolbar.\n     * @param connectionId The stream's connection ID for the video feed whose canvas should be removed.\n     */\n    this.removeCanvas = function (connectionId) {\n      canvases.forEach(function (annotationView) {\n        var canvas = annotationView.canvas();\n        if (annotationView.videoFeed.stream.connection.connectionId === connectionId) {\n          if (canvas.parentNode) {\n            canvas.parentNode.removeChild(canvas);\n          }\n        }\n      });\n      canvases = canvases.filter(function (annotationView) {\n        return annotationView.videoFeed.stream.connection.connectionId !== connectionId;\n      });\n    };\n\n    /**\n     * Removes the toolbar and all associated annotation canvases from their parent containers.\n     */\n    this.remove = function () {\n      try {\n        panel.parentNode.removeChild(panel);\n      } catch (e) {\n        console.log('Toolbar parent no longer exists');\n      }\n      canvases.forEach(function (annotationView) {\n        var canvas = annotationView.canvas();\n        if (canvas.parentNode) {\n          canvas.parentNode.removeChild(canvas);\n        }\n      });\n      canvases = [];\n    };\n  };\n}).call(this);","map":{"version":3,"names":["_","$","OTKAnalytics","module","exports","require","_this","_accPack","_session","_canvas","_subscribingToMobileScreen","_elements","_otkanalytics","_logEventData","clientVersion","componentId","name","actionInitialize","actionStart","actionEnd","actionFreeHand","actionPickerColor","actionText","actionScreenCapture","actionErase","actionUseToolbar","variationAttempt","variationError","variationSuccess","_logAnalytics","_source","window","location","href","otkanalyticsData","source","sessionInfo","sessionId","id","connectionId","connection","partnerId","apiKey","addSessionInfo","_log","action","variation","data","logEvent","_getElem","el","document","querySelector","_triggerEvent","event","triggerEvent","_registerEvents","events","registerEvents","_setupUI","toolbar","join","append","_palette","_aspectRatio","_refreshCanvas","throttle","onResize","_resizeCanvas","width","height","cobrowsing","cobrowsingImage","absoluteParent","canvasContainer","clientWidth","clientHeight","videoDimensions","videoFeed","stream","e","console","log","origRatio","destRatio","calcDimensions","top","left","externalWindow","find","css","attr","trailing","_changeColorByIndex","colorIndex","changeColorByIndex","_takeScreenShot","captureScreenshot","_listenForResize","resizeSubject","on","_createToolbar","session","options","toolbarId","property","items","shapes","colors","imageAssets","backgroundColor","container","w","getElementById","OTSolution","Annotations","Toolbar","length","itemClicked","actions","OT_pen","OT_colors","OT_text","OT_clear","_createExternalWindow","deferred","Deferred","screen","externalWindowHTML","windowFeatures","annotationWindow","open","write","onbeforeunload","close","OT","triggerCloseEvent","windowReady","createContainerElements","ready","resolve","setTimeout","promise","_removeToolbar","onClearAnnotation","off","remove","_requestPlatformData","pubSub","mobileInitiator","isPublisher","Object","prototype","hasOwnProperty","call","signal","type","to","platform","JSON","parse","isMobile","onMobileScreenShare","start","then","createPanel","linkCanvas","feed","addCanvas","onScreenCapture","dataUrl","win","focus","context","canvas","first","getElementsByTagName","resizeCanvas","takeScreenShot","addSubscriberToExternalWindow","addSubscriberVideo","end","hideToolbar","parent","hide","showToolbar","show","AnnotationAccPack","omit","Error","constructor","define","amd","_OTKAnalytics","actionStartDrawing","actionEndDrawing","DEFAULT_ASSET_URL","widgetVersion","self","createElement","setAttribute","style","position","appendChild","getComputedStyle","VideoRelativeCoordinateSet","update","returnedObj","scale","X","publishingScreenToMobileDevice","subscribingToMobileScreen","canvasWidth","Y","canvasHeight","keys","forEach","coord","verb","defineProperty","get","set","newVal","ctx","cbs","mirrored","scaledToFill","batchUpdates","drawHistory","drawHistoryReceivedFrom","updateHistory","eventHistory","isStartPoint","isVideo","element","client","dragging","className","indexOf","link","changeColor","color","userColor","lineWidth","colorChoices","querySelectorAll","classList","add","button","borderRadius","changeLineWidth","size","selectItem","item","overlay","removeChild","updateSelected","current","selectedItem","shapesBtn","currentIsShape","contains","newlySelected","parentElement","clear","clearCanvas","undo","undoLast","isAnnotationEnd","canvasCopy","videoWidth","videoHeight","offsetX","offsetY","image","Image","onload","ctxCopy","getContext","translate","drawImage","cb","src","toDataURL","imgData","getImgData","currentWindow","replace","push","mobile","publishing","drawUpdates","draw","dismissTextAnnotation","addEventListeners","s","fn","evts","split","i","iLen","addEventListener","updateCanvas","resizeEvent","getBoundingClientRect","offsetLeft","offsetTop","baseWidth","baseHeight","scaleX","scaleY","pageX","changedTouches","pageY","x","y","lastX","lastY","fromId","fromX","_lastX","fromY","_lastY","toX","toY","videoElement","startPoint","endPoint","guid","sendUpdate","inputHeight","font","text","shapeLineWidth","points","mX","mY","isDrawing","startX","startY","_startX","_startY","_mX","_mY","smoothed","scaleForPoints","firstPoint","pointX","pointY","enableSmoothing","c","r","Math","random","v","toString","istextEvent","notDragging","preventDefault","textEvent","textInputId","commitPopId","commitPopClickId","dismissPopId","ignoreClicks","handleClick","createTextInput","processTextEvent","textInput","inputheight","value","clientY","clientX","background","maxWidth","border","fontSize","fontFamily","zIndex","stringify","body","which","creteCommitPop","commitPop","dataset","commitPopText","createTextNode","commitPopClick","dismissDiv","lineCap","lineJoin","fillStyle","clearRect","history","strokeStyle","secondPoint","isText","fillText","closePath","beginPath","moveTo","quadraticCurveTo","stroke","lineTo","title","drawPoints","_pointX","_pointY","minX","Number","MAX_VALUE","minY","maxX","maxY","dx","abs","dy","drawIncoming","index","iCanvas","iVideo","video","updateForHistory","updates","incoming","cid","filter","itemsToRemove","historyItem","removed","removedItems","undoLastIos","splice","includes","count","signal:otAnnotation_pen","from","paths","signal:otAnnotation_text","signal:otAnnotation_history","signal:otAnnotation_clear","signal:otAnnotation_undo","connectionCreated","batchSignal","toConnection","signalError","err","TB","error","updateType","chunk","dataChunk","updatesPerSignal","slice","updateTimeout","_toolbar","subpanelBackgroundColor","toolbarItems","icon","selectedIcon","cos","PI","sin","getItems","itemNames","shapeNames","addItem","acc","toolbarItem","reduce","shapeAcc","shape","shapeIndex","concat","itemsToBuild","canvases","ColorPicker","getElm","all","render","html","template","elm","innerHTML","colorChosen","p","openEvent","ev","target","getAttribute","Array","autoclose","panel","subPanel","total","toLowerCase","colorPicker","pk","colorGroup","isArray","outerHTML","toggleColorsHover","hover","onclick","group","itemName","attachDefaultAction","selectedGroup","submenuItems","subItem","itemButton","lineIcon","transform","pointerEvents","lastBtn","selBtn","backgroundSize","iconWidth","iconHeight","backgroundPosition","onClear","evt","detail","removeCanvas","annotationView","parentNode"],"sources":["/home/awolf/WebstormProjects/accelerator-sample-apps-js/react-sample-app/node_modules/opentok-annotation/dist/opentok-annotation.js"],"sourcesContent":["/* global OT OTSolution OTKAnalytics ScreenSharingAccPack define */\n(function () {\n  /** Include external dependencies */\n  var _;\n  var $;\n  var OTKAnalytics;\n\n  if (typeof module === 'object' && typeof module.exports === 'object') {\n    /* eslint-disable import/no-unresolved */\n    _ = require('underscore');\n    $ = require('jquery');\n    OTKAnalytics = require('opentok-solutions-logging');\n    /* eslint-enable import/no-unresolved */\n  } else {\n    _ = this._;\n    $ = this.$;\n    OTKAnalytics = this.OTKAnalytics;\n  }\n\n  /** Private variables */\n  var _this;\n  var _accPack;\n  var _session;\n  var _canvas;\n  var _subscribingToMobileScreen;\n  var _elements = {};\n\n  /** Analytics */\n  var _otkanalytics;\n\n  // vars for the analytics logs. Internal use\n  var _logEventData = {\n    clientVersion: 'js-vsol-2.0.59', // x.y.z filled by npm build script\n    componentId: 'annotationsAccPack',\n    name: 'guidAnnotationsKit',\n    actionInitialize: 'Init',\n    actionStart: 'Start',\n    actionEnd: 'End',\n    actionFreeHand: 'FreeHand',\n    actionPickerColor: 'PickerColor',\n    actionText: 'Text',\n    actionScreenCapture: 'ScreenCapture',\n    actionErase: 'Erase',\n    actionUseToolbar: 'UseToolbar',\n    variationAttempt: 'Attempt',\n    variationError: 'Failure',\n    variationSuccess: 'Success',\n  };\n\n  var _logAnalytics = function () {\n    // init the analytics logs\n    var _source = window.location.href;\n\n    var otkanalyticsData = {\n      clientVersion: _logEventData.clientVersion,\n      source: _source,\n      componentId: _logEventData.componentId,\n      name: _logEventData.name\n    };\n\n    _otkanalytics = new OTKAnalytics(otkanalyticsData);\n\n    var sessionInfo = {\n      sessionId: _session.id,\n      connectionId: _session.connection.connectionId,\n      partnerId: _session.apiKey\n    };\n\n    _otkanalytics.addSessionInfo(sessionInfo);\n  };\n\n  var _log = function (action, variation) {\n    var data = {\n      action: action,\n      variation: variation\n    };\n    _otkanalytics.logEvent(data);\n  };\n\n  /** End Analytics */\n\n  // Check for DOM element or string.  Return element.\n  var _getElem = function (el) {\n    return typeof el === 'string' ? document.querySelector(el) : el;\n  };\n\n  // Trigger event via common layer API\n  var _triggerEvent = function (event, data) {\n    if (_accPack) {\n      _accPack.triggerEvent(event, data);\n    }\n  };\n\n  var _registerEvents = function () {\n    if (_accPack) {\n      var events = [\n        'startAnnotation',\n        'linkAnnotation',\n        'resizeCanvas',\n        'annotationWindowClosed',\n        'endAnnotation'\n      ];\n\n      _accPack.registerEvents(events);\n    }\n  };\n\n  var _setupUI = function () {\n    var toolbar = [\n      '<div id=\"annotationToolbarContainer\" class=\"ots-annotation-toolbar-container\">',\n      '<div id=\"toolbar\"></div>',\n      '</div>'\n    ].join('\\n');\n    $('body').append(toolbar);\n    _log(_logEventData.actionUseToolbar, _logEventData.variationSuccess);\n  };\n\n  var _palette = [\n    '#1abc9c',\n    '#2ecc71',\n    '#3498db',\n    '#9b59b6',\n    '#8e44ad',\n    '#f1c40f',\n    '#e67e22',\n    '#e74c3c',\n    '#ded5d5'\n  ];\n\n  var _aspectRatio = (10 / 6);\n\n  /** Private methods */\n\n  var _refreshCanvas = _.throttle(function () {\n    _canvas.onResize();\n  }, 1000);\n\n  /** Resize the canvas to match the size of its container */\n  var _resizeCanvas = _.throttle(function () {\n    var width;\n    var height;\n    var cobrowsing = !!_elements.cobrowsingImage;\n    if (cobrowsing) {\n      // Cobrowsing images are currently fixed size, so resize isn't needed\n      return;\n    }\n\n    if (_elements.cobrowsingImage === null) {\n      var el = _elements.absoluteParent || _elements.canvasContainer;\n      width = el.clientWidth;\n      height = el.clientHeight;\n    }\n\n    try {\n      var videoDimensions = _canvas.videoFeed.stream.videoDimensions;\n    } catch (e) {\n      console.log('OT Annotation: Annotation video stream no longer exists');\n      return;\n    }\n\n    // Override dimensions when subscribing to a mobile screen\n    if (_subscribingToMobileScreen) {\n      videoDimensions.width = width;\n      videoDimensions.height = height;\n    }\n    var origRatio = videoDimensions.width / videoDimensions.height;\n    var destRatio = width / height;\n    var calcDimensions = {\n      top: 0,\n      left: 0,\n      height: height,\n      width: width\n    };\n\n    if (!_elements.externalWindow) {\n      if (origRatio < destRatio) {\n        // height is the limiting prop, we'll get vertical bars\n        calcDimensions.width = calcDimensions.height * origRatio;\n        calcDimensions.left = (width - calcDimensions.width) / 2;\n      } else {\n        calcDimensions.height = calcDimensions.width / origRatio;\n        calcDimensions.top = (height - calcDimensions.height) / 2;\n      }\n    }\n\n    $(_elements.canvasContainer).find('canvas').css(calcDimensions);\n\n    $(_elements.canvasContainer).find('canvas').attr(calcDimensions);\n\n    _refreshCanvas();\n    _triggerEvent('resizeCanvas');\n  }, 500, {trailing: false});\n\n  var _changeColorByIndex = function (colorIndex) {\n    _canvas.changeColorByIndex(colorIndex);\n  };\n\n  var _takeScreenShot = function () {\n    _canvas.captureScreenshot(true);\n  };\n\n  var _listenForResize = function () {\n    $(_elements.resizeSubject).on('resize', _resizeCanvas);\n  };\n\n  var _createToolbar = function (session, options, externalWindow) {\n    _setupUI();\n\n    var toolbarId = _.property('toolbarId')(options) || 'toolbar';\n    var items = _.property('toolbarItems')(options) || [];\n    var shapes = _.property('toolbarShapes')(options) || [];\n    var colors = _.property('colors')(options) || _palette;\n    var imageAssets = _.property('imageAssets')(options) || null;\n    var backgroundColor = _.property('backgroundColor')(options) || null;\n\n    var container = function () {\n      var w = !!externalWindow ? externalWindow : window;\n      return w.document.getElementById(toolbarId);\n    };\n\n    /* eslint-disable no-native-reassign */\n    toolbar = new OTSolution.Annotations.Toolbar({\n      session: session,\n      container: container(),\n      colors: colors,\n      items: items.length ? items : ['*'],\n      shapes: shapes.length ? shapes : ['rectangle', 'oval', 'star', 'arrow', 'line'],\n      externalWindow: externalWindow || null,\n      imageAssets: imageAssets,\n      backgroundColor: backgroundColor,\n      OTKAnalytics: OTKAnalytics\n    });\n\n    toolbar.itemClicked(function (id) {\n      var actions = {\n        OT_pen: _logEventData.actionFreeHand,\n        OT_colors: _logEventData.actionPickerColor,\n        OT_text: _logEventData.actionText,\n        OT_clear: _logEventData.actionErase\n      };\n\n      var action = actions[id];\n\n      if (!!action) {\n        _log(action, _logEventData.variationSuccess);\n      }\n    });\n\n    /* eslint-enable no-native-reassign */\n  };\n\n  // Create external screen sharing window\n  var _createExternalWindow = function () {\n    var deferred = $.Deferred();\n\n    var width = screen.width * 0.80 | 0;\n    var height = width / (_aspectRatio);\n    var externalWindowHTML = '<!DOCTYPE html><html lang=\"en\"><head><meta http-equiv=\"Content-type\" content=\"text/html; charset=utf-8\"><title>OpenTok Screen Sharing Solution Annotation</title><link rel=\"stylesheet\" href=\"https://assets.tokbox.com/solutions/css/style.css\"><style type=\"text/css\" media=\"screen\"> body{margin:0;background-color:rgba(0,153,203,.7);box-sizing:border-box;height:100vh}canvas{top:0;z-index:1000}.hidden{display:none}.ots-hidden{display:none !important}.main-wrap{width:100%;height:100%;-ms-box-orient:horizontal;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-moz-flex;display:-webkit-flex;display:flex;-webkit-justify-content:center;justify-content:center;-webkit-align-items:center;align-items:center}.inner-wrap{position:relative;border-radius:8px;overflow:hidden}.publisherContainer{display:block;background-color:#000;position:absolute}.publisher-wrap{height:100%;width:100%}.subscriberContainer{position:absolute;display:flex;top:20px;left:20px;width:200px;height:120px;background-color:#000;border:2px solid #fff;border-radius:6px}.subscriberContainer .OT_video-poster{width:100%;height:100%;opacity:.25;background-repeat:no-repeat;background-image:url(https://static.opentok.com/webrtc/v2.8.2/images/rtc/audioonly-silhouette.svg);background-size:50%;background-position:center}.OT_video-element{height:100%;width:100%}.OT_edge-bar-item{display:none}</style></head><body> <div class=\"main-wrap\"> <div id=\"annotationContainer\" class=\"inner-wrap\"></div></div><div id=\"toolbarContainer\" class=\"ots-annotation-toolbar-container\"> <div id=\"toolbar\" class=\"toolbar-wrap\"></div></div><div id=\"subscriberVideo\" class=\"subscriberContainer hidden\"></div><script type=\"text/javascript\" charset=\"utf-8\"> /** Must use double-quotes since everything must be converted to a string */ var opener; var canvas; if (!toolbar){alert(\"Something went wrong: You must pass an OpenTok annotation toolbar object into the window.\")}else{opener=window.opener; window.onbeforeunload=window.triggerCloseEvent;}var localScreenProperties={insertMode: \"append\", width: \"100%\", height: \"100%\", videoSource: \"window\", showControls: false, style:{buttonDisplayMode: \"off\"}, subscribeToVideo: \"true\", subscribeToAudio: \"false\", fitMode: \"contain\"}; var createContainerElements=function(){var parentDiv=document.getElementById(\"annotationContainer\"); var publisherContainer=document.createElement(\"div\"); publisherContainer.setAttribute(\"id\", \"screenshare_publisher\"); publisherContainer.classList.add(\"publisher-wrap\"); parentDiv.appendChild(publisherContainer); return{annotation: parentDiv, publisher: publisherContainer};}; var addSubscriberVideo=function(stream){var container=document.getElementById(\"subscriberVideo\"); var subscriber=session.subscribe(stream, container, localScreenProperties, function(error){if (error){console.log(\"Failed to add subscriber video\", error);}container.classList.remove(\"hidden\");});}; if (navigator.userAgent.indexOf(\"Firefox\") !==-1){var ghost=window.open(\"about:blank\"); ghost.focus(); ghost.close();}</script></body></html>';\n\n    /* eslint-disable max-len */\n    var windowFeatures = [\n      'toolbar=no',\n      'location=no',\n      'directories=no',\n      'status=no',\n      'menubar=no',\n      'scrollbars=no',\n      'resizable=no',\n      'copyhistory=no', ['width=', width].join(''), ['height=', height].join(''), ['left=', ((screen.width / 2) - (width / 2))].join(''), ['top=', ((screen.height / 2) - (height / 2))].join('')\n    ].join(',');\n    /* eslint-enable max-len */\n\n    var annotationWindow = window.open('about:blank', '', windowFeatures);\n    annotationWindow.document.write(externalWindowHTML);\n    window.onbeforeunload = function () {\n      annotationWindow.close();\n    };\n\n    // External window needs access to certain globals\n    annotationWindow.toolbar = toolbar;\n    annotationWindow.OT = OT;\n    annotationWindow.session = _session;\n    annotationWindow.$ = $;\n\n    annotationWindow.triggerCloseEvent = function () {\n      _triggerEvent('annotationWindowClosed');\n    };\n\n    annotationWindow.onbeforeunload = function () {\n      _triggerEvent('annotationWindowClosed');\n    };\n\n    // TODO Find something better.\n    var windowReady = function () {\n      if (!!annotationWindow.createContainerElements) {\n        $(annotationWindow.document).ready(function () {\n          deferred.resolve(annotationWindow);\n        });\n      } else {\n        setTimeout(windowReady, 100);\n      }\n    };\n\n    windowReady();\n\n    return deferred.promise();\n  };\n\n  // Remove the toolbar and cancel event listeners\n  var _removeToolbar = function () {\n    _canvas.onClearAnnotation();\n    $(_elements.resizeSubject).off('resize', _resizeCanvas);\n    toolbar.remove();\n    $('#annotationToolbarContainer').remove();\n  };\n\n  // Determine whether or not the subscriber stream is from a mobile device\n  var _requestPlatformData = function (pubSub, mobileInitiator) {\n    if (!!pubSub.stream) {\n\n      var isPublisher = Object.prototype.hasOwnProperty.call(pubSub, 'accessAllowed');\n\n      _session.signal({\n        type: 'otAnnotation_requestPlatform',\n        to: pubSub.stream.connection,\n      });\n\n      _session.on('signal:otAnnotation_mobileScreenShare', function (event) {\n        var platform = event.data ? JSON.parse(event.data).platform : null;\n        var isMobile = (platform == 'ios' || platform === 'android');\n        _subscribingToMobileScreen = isMobile;\n        _canvas.onMobileScreenShare(isMobile, isPublisher);\n      });\n    }\n\n    if (mobileInitiator) {\n      _subscribingToMobileScreen = true;\n      _canvas.onMobileScreenShare(true);\n    }\n  };\n\n  /**\n   * Creates an external window (if required) and links the annotation toolbar\n   * to the session\n   * @param {object} session\n   * @param {object} [options]\n   * @param {boolean} [options.screensharing] - Using an external window\n   * @param {string} [options.toolbarId] - If the container has an id other than 'toolbar'\n   * @param {array} [options.items] - Custom set of tools\n   * @param {array} [options.colors] - Custom color palette\n   * @returns {promise} < Resolve: undefined | {object} Reference to external annotation window >\n   */\n  var start = function (session, options) {\n    var deferred = $.Deferred();\n\n    if (_.property('screensharing')(options)) {\n      _createExternalWindow()\n        .then(function (externalWindow) {\n          _createToolbar(session, options, externalWindow);\n          toolbar.createPanel(externalWindow);\n          _triggerEvent('startAnnotation', externalWindow);\n          _log(_logEventData.actionStart, _logEventData.variationSuccess);\n          deferred.resolve(externalWindow);\n        });\n    } else {\n      _createToolbar(session, options);\n      _triggerEvent('startAnnotation');\n      _log(_logEventData.actionStart, _logEventData.variationSuccess);\n      deferred.resolve();\n    }\n\n    return deferred.promise();\n  };\n\n  /**\n   * @param {object} pubSub - Either the publisher(sharing) or subscriber(viewing)\n   * @ param {object} container - The parent container for the canvas element\n   * @ param {object} options\n   * @param {object} options.canvasContainer - The id of the parent for the annotation canvas\n   * @param {object | string} [options.externalWindow] - Reference to the annotation window (or query selector) if publishing\n   * @param {array | string} [options.absoluteParent] - Reference to element (or query selector) for resize if other than container\n   * * @param {Boolean} [options.mobileInitiator] - Is cobrowsing being initiated by a mobile device\n   */\n  var linkCanvas = function (pubSub, container, options) {\n    /**\n     * jQuery only allows listening for a resize event on the window or a\n     * jQuery resizable element, like #wmsFeedWrap.  windowRefernce is a\n     * reference to the popup window created for annotation.  If this doesn't\n     * exist, we are watching the canvas belonging to the party viewing the\n     * shared screen\n     */\n    _elements.resizeSubject = _getElem(_.property('externalWindow')(options) || window);\n    _elements.externalWindow = _getElem(_.property('externalWindow')(options) || null);\n    _elements.absoluteParent = _getElem(_.property('absoluteParent')(options) || null);\n    _elements.cobrowsingImage = _getElem(_.property('cobrowsingImage')(options) || null);\n    _elements.canvasContainer = _getElem(container);\n\n    // The canvas object\n    _canvas = new OTSolution.Annotations({\n      feed: pubSub,\n      container: _elements.canvasContainer,\n      externalWindow: _elements.externalWindow\n    });\n\n    toolbar.addCanvas(_canvas, _elements.externalWindow);\n\n    var onScreenCapture = _this.options.onScreenCapture ? _this.options.onScreenCapture :\n      function (dataUrl) {\n        var win = window.open(dataUrl, '_blank');\n        win.focus();\n      };\n\n    _canvas.onScreenCapture(onScreenCapture);\n    _requestPlatformData(pubSub, options && options.mobileInitiator);\n\n    var context = _elements.externalWindow ? _elements.externalWindow : window;\n    // The canvas DOM element\n    _elements.canvas = $(_.first(context.document.getElementsByTagName('canvas')));\n\n    _listenForResize();\n    _resizeCanvas();\n    _triggerEvent('linkAnnotation');\n  };\n\n  /**\n   * Manually update the size of the canvas to match it's container, or the\n   * absolute parent, if defined.\n   */\n  var resizeCanvas = function () {\n    _resizeCanvas();\n  };\n\n  /**\n   * Change the annotation color of the toolbar passing the colorIndex\n   * @param {Integer} colorIndex - The color index number\n   */\n  var changeColorByIndex = function (colorIndex) {\n    _changeColorByIndex(colorIndex);\n  };\n\n  var takeScreenShot = function () {\n    _takeScreenShot();\n  };\n\n  /**\n   * Adds a subscriber's video the external annotation window\n   * @param {Object} stream - The subscriber stream object\n   */\n  var addSubscriberToExternalWindow = function (stream) {\n    if (!_elements.externalWindow) {\n      console.log('OT Annotation: External window does not exist. Cannot add subscriber video.');\n    } else {\n      _elements.externalWindow.addSubscriberVideo(stream);\n    }\n  };\n\n  /**\n   * Stop annotation and clean up components\n   * @param {Boolean} publisher Are we the publisher?\n   */\n  var end = function () {\n    _removeToolbar();\n    _elements.canvas = null;\n\n    if (!!_elements.externalWindow) {\n      _elements.externalWindow.close();\n      _elements.externalWindow = null;\n      _elements.resizeSubject = null;\n    }\n    _triggerEvent('endAnnotation');\n\n    _log(_logEventData.actionEnd, _logEventData.variationSuccess);\n  };\n\n  var hideToolbar = function () {\n    $(toolbar.parent).hide();\n  };\n\n  var showToolbar = function () {\n    $(toolbar.parent).show();\n  };\n\n  /**\n   * @constructor\n   * Represents an annotation component, used for annotation over video or a shared screen\n   * @param {object} options\n   * @param {object} options.session - An OpenTok session\n   * @param {object} options.canvasContainer - The id of the parent for the annotation canvas\n   * @param {object} options.watchForResize - The DOM element to watch for resize\n   * @param {object} options.onScreenCapture- A callback function to be invoked on screen capture\n   */\n  var AnnotationAccPack = function (options) {\n    _this = this;\n    _this.options = _.omit(options, 'accPack', 'session');\n    _accPack = _.property('accPack')(options);\n    _session = _.property('session')(options);\n\n    if (!_session) {\n      throw new Error('OpenTok Annotation Accelerator Pack requires an OpenTok session');\n    }\n    _registerEvents();\n    // init analytics logs\n    _logAnalytics();\n    _log(_logEventData.actionInitialize, _logEventData.variationSuccess);\n  };\n\n  AnnotationAccPack.prototype = {\n    constructor: AnnotationAccPack,\n    start: start,\n    linkCanvas: linkCanvas,\n    resizeCanvas: resizeCanvas,\n    addSubscriberToExternalWindow: addSubscriberToExternalWindow,\n    end: end,\n    hideToolbar: hideToolbar,\n    showToolbar: showToolbar,\n    changeColorByIndex: changeColorByIndex,\n    takeScreenShot: takeScreenShot\n  };\n\n  if (typeof exports === 'object') {\n    module.exports = AnnotationAccPack;\n  } else if (typeof define === 'function' && define.amd) {\n    define(function () {\n      return AnnotationAccPack;\n    });\n  } else {\n    this.AnnotationAccPack = AnnotationAccPack;\n  }\n}.call(this));\n\n/*!\n *  Annotation Plugin for OpenTok\n *\n *  @Author: Trevor Boyer\n *  @Copyright (c) 2015 TokBox, Inc\n **/\n\n/* eslint-disable */\n\n/** Analytics */\n(function () {\n\n  var _OTKAnalytics;\n  var _otkanalytics;\n  var _session;\n\n\n  // vars for the analytics logs. Internal use\n  var _logEventData = {\n    clientVersion: 'js-vsol-2.0.59', // x.y.z filled by npm build script\n    componentId: 'annotationsAccPack',\n    name: 'guidAnnotationsKit',\n    actionStartDrawing: 'StartDrawing',\n    actionEndDrawing: 'EndDrawing',\n    variationSuccess: 'Success',\n  };\n\n  var _logAnalytics = function () {\n    // init the analytics logs\n    var _source = window.location.href;\n\n    var otkanalyticsData = {\n      clientVersion: _logEventData.clientVersion,\n      source: _source,\n      componentId: _logEventData.componentId,\n      name: _logEventData.name\n    };\n\n    _otkanalytics = new _OTKAnalytics(otkanalyticsData);\n\n    var sessionInfo = {\n      sessionId: _session.id,\n      connectionId: _session.connection.connectionId,\n      partnerId: _session.apiKey\n    };\n\n    _otkanalytics.addSessionInfo(sessionInfo);\n  };\n\n  var _log = function (action, variation) {\n    var data = {\n      action: action,\n      variation: variation\n    };\n    _otkanalytics.logEvent(data);\n  };\n\n  /** End Analytics */\n\n\n  //--------------------------------------\n  //  OPENTOK ANNOTATION CANVAS/VIEW\n  //--------------------------------------\n  var DEFAULT_ASSET_URL = 'https://assets.tokbox.com/solutions/images/';\n\n  OTSolution = this.OTSolution || {};\n\n  OTSolution.Annotations = function (options) {\n\n    options = options || {};\n    this.widgetVersion = 'js-1.0.0-beta';\n    this.parent = options.container;\n    this.videoFeed = options.feed;\n    this.imageAssets = options.imageAssets || DEFAULT_ASSET_URL;\n\n    _OTKAnalytics = _OTKAnalytics || options.OTKAnalytics;\n    if (!_otkanalytics) {\n      _logAnalytics();\n    }\n\n    if (typeof module === 'object' && typeof module.exports === 'object') {\n      $ = require('jquery');\n    }\n\n    var context = options.externalWindow ? options.externalWindow.document : window.document;\n\n    var self = this;\n\n    if (this.parent) {\n      var canvas = document.createElement('canvas');\n      canvas.setAttribute('id', 'opentok_canvas'); // session.connection.id?\n      canvas.style.position = 'absolute';\n      this.parent.appendChild(canvas);\n      canvas.setAttribute('width', this.parent.clientWidth + 'px');\n      canvas.style.width = window.getComputedStyle(this.parent).width;\n      canvas.setAttribute('height', this.parent.clientHeight + 'px');\n      canvas.style.height = window.getComputedStyle(this.parent).height;\n    }\n\n    function VideoRelativeCoordinateSet(update) {\n\n      var returnedObj = {};\n\n      var scale = {\n        get X() {\n          if (publishingScreenToMobileDevice || (cobrowsing && subscribingToMobileScreen)) {\n            return update.canvasWidth / canvas.width;\n          }\n          var width = cobrowsing ? canvas.width : self.videoFeed.stream.videoDimensions.width;\n          return width / canvas.width;\n        },\n        get Y() {\n          if (publishingScreenToMobileDevice || (cobrowsing && subscribingToMobileScreen)) {\n            return update.canvasHeight / canvas.height;\n          }\n          var height = cobrowsing ? canvas.height : self.videoFeed.stream.videoDimensions.height;\n          return height / canvas.height;\n        }\n      };\n\n      Object.keys(update).forEach(function (attr) {\n        returnedObj[attr] = update[attr];\n      });\n      ['X', 'Y'].forEach(function (coord) {\n        ['to', 'from', 'last', 'm', 'start', 'point'].forEach(function (verb) {\n          var attr = verb + coord;\n          returnedObj['_' + attr] = returnedObj[attr];\n          Object.defineProperty(returnedObj, attr, {\n            get: function () {\n              return returnedObj['_' + attr] / scale[coord];\n            },\n            set: function (newVal) {\n              returnedObj['_' + attr] = newVal; // * scale[coord];\n            }\n          });\n        });\n      });\n      return returnedObj;\n    }\n\n\n    var self = this;\n    var ctx;\n    var cbs = [];\n    var isPublisher;\n    var mirrored;\n    var scaledToFill;\n    var batchUpdates = [];\n    var drawHistory = [];\n    var drawHistoryReceivedFrom = [];\n    var updateHistory = [];\n    var eventHistory = [];\n    var isStartPoint = false;\n    var isVideo = self.videoFeed && self.videoFeed.element ? true : false;\n    var cobrowsing = !self.videoFeed.stream;\n    var subscribingToMobileScreen = false;\n    var publishingScreenToMobileDevice = false;\n    var client = new VideoRelativeCoordinateSet({\n      dragging: false\n    });\n\n\n    // INFO Mirrored feeds contain the OT_mirrored class\n    if (isVideo) {\n      isPublisher = (' ' + self.videoFeed.element.className + ' ').indexOf(' ' + 'OT_publisher' + ' ') > -1;\n      mirrored = isPublisher ? (' ' + self.videoFeed.element.className + ' ').indexOf(' ' + 'OT_mirrored' + ' ') > -1 : false;\n      scaledToFill = (' ' + self.videoFeed.element.className + ' ').indexOf(' ' + 'OT_fit-mode-cover' + ' ') > -1;\n    } else {\n      mirrored = false;\n      scaledToFill = false;\n    }\n\n    this.canvas = function () {\n      return canvas;\n    };\n\n    /**\n     * Links an OpenTok session to the annotation canvas. Typically, this is automatically linked\n     * when using {@link Toolbar#addCanvas}.\n     * @param session The OpenTok session.\n     */\n    this.link = function (session) {\n      this.session = session;\n    };\n\n    /**\n     * Changes the active annotation color for the canvas.\n     * @param color The hex string representation of the color (#rrggbb).\n     */\n    this.changeColor = function (color) {\n      self.userColor = color;\n      if (!self.lineWidth) {\n        self.lineWidth = 2; // TODO Default to first option in list of line widths\n      }\n    };\n\n    /**\n     * Changes the active annotation color for the canvas.\n     * @param colorIndex - the index regarding the colors array\n     */\n    this.changeColorByIndex = function (colorIndex) {\n\n      //set the user color\n      self.userColor = this.colors[colorIndex];\n\n      //activate the change on the toolbar\n      var colorChoices = context.querySelectorAll('.color-choice');\n      colorChoices[colorIndex].classList.add('active');\n      var button = context.getElementById('OT_colors');\n      button.setAttribute('class', 'OT_color annotation-btn colors');\n      button.style.borderRadius = '50%';\n      button.style.backgroundColor = this.colors[colorIndex];\n    };\n\n    /**\n     * Changes the line/stroke width of the active annotation for the canvas.\n     * @param size The size in pixels.\n     */\n    this.changeLineWidth = function (size) {\n      this.lineWidth = size;\n    };\n\n    /**\n     * Sets the selected menu item from the toolbar. This is typically handled\n     * automatically by the toolbar, but can be used to programmatically select an item.\n     * @param item The menu item to set as selected.\n     */\n    this.selectItem = function (item) {\n      if (self.overlay) {\n        self.parent.removeChild(self.overlay);\n        self.overlay = null;\n      }\n\n      /**\n       * Update classes for toolbar items\n       */\n      var updateSelected = function () {\n\n        // Remove the 'selected' class from the currently selected item (or parent)\n        var current = context.getElementById(self.selectedItem.id);\n        var shapesBtn = context.getElementById('OT_shapes');\n        var currentIsShape = shapesBtn.classList.contains('selected');\n        currentIsShape ? shapesBtn.classList.remove('selected') : current.classList.remove('selected');\n\n        // If the newly selected item is a shape, update the shapes subpanel button\n        var newlySelected = context.getElementById(item.id);\n        if (newlySelected.parentElement.classList.contains('shapes')) {\n          shapesBtn.classList.add('selected');\n        } else {\n          newlySelected.classList.add('selected');\n        }\n      }\n\n      if (item && item.id === 'OT_capture') {\n        self.captureScreenshot();\n      } else if (item && item.id.indexOf('OT_line_width') !== -1) {\n        if (item.size) {\n          self.changeLineWidth(item.size);\n        }\n        // 'undo' and 'clear' are actions, not items that can be selected\n      } else if (item.id !== 'OT_undo' && item.id !== 'OT_clear') {\n        updateSelected();\n        self.selectedItem = item;\n      }\n    };\n\n    /**\n     * Sets the color palette for the color picker\n     * @param colors The array of hex color strings (#rrggbb).\n     */\n    this.colors = function (colors) {\n      this.colors = colors;\n      this.changeColor(colors[0]);\n    };\n\n    /**\n     * Clears the canvas for the active user. Only annotations added by the active OpenTok user will\n     * be removed, leaving the history of all other annotations.\n     */\n    this.clear = function () {\n      clearCanvas(false, self.session.connection.connectionId);\n      if (self.session) {\n        self.session.signal({\n          type: 'otAnnotation_clear'\n        });\n      }\n    };\n\n    this.undo = function () {\n      undoLast(false, self.session.connection.connectionId);\n    }\n\n    // TODO Allow the user to choose the image type? (jpg, png) Also allow size?\n    /**\n     * Captures a screenshot of the annotations displayed on top of the active video feed.\n     */\n    this.captureScreenshot = function (isAnnotationEnd) {\n\n      var canvasCopy = document.createElement('canvas');\n      canvasCopy.width = canvas.width;\n      canvasCopy.height = canvas.height;\n\n      var width = isVideo ? self.videoFeed.videoWidth() : canvas.width;\n      var height = isVideo ? self.videoFeed.videoHeight() : canvas.height;\n\n      var scale = 1;\n\n      var offsetX = 0;\n      var offsetY = 0;\n\n      if (scaledToFill) {\n        if (width < height) {\n          scale = canvas.width / width;\n          width = canvas.width;\n          height = height * scale;\n        } else {\n          scale = canvas.height / height;\n          height = canvas.height;\n          width = width * scale;\n        }\n        // If stretched to fill, we need an offset to center the image\n        offsetX = (width - canvas.width) / 2;\n        offsetY = (height - canvas.height) / 2;\n\n      } else {\n        if (width > height) {\n          scale = canvas.width / width;\n          width = canvas.width;\n          height = height * scale;\n          offsetX = 0;\n          offsetY = (canvas.height - height) / 2;\n        } else {\n          scale = canvas.height / height;\n          height = canvas.height;\n          width = width * scale;\n          offsetX = (canvas.width - width) / 2;\n          offsetY = 0;\n        }\n\n      }\n\n      // Combine the video and annotation images\n      var image = new Image();\n\n      image.onload = function () {\n        var ctxCopy = canvasCopy.getContext('2d');\n        if (mirrored) {\n          ctxCopy.translate(width, 0);\n          ctxCopy.scale(-1, 1);\n        }\n        ctxCopy.drawImage(image, offsetX, offsetY, width, height);\n\n        // We want to make sure we draw the annotations the same way, so we need to flip back\n        if (mirrored) {\n          ctxCopy.translate(width, 0);\n          ctxCopy.scale(-1, 1);\n        }\n        ctxCopy.drawImage(canvas, 0, 0);\n\n        cbs.forEach(function (cb) {\n          var data = { src: canvasCopy.toDataURL(), isAnnotationEnd: isAnnotationEnd };\n          cb.call(self, data);\n        });\n\n        // Clear and destroy the canvas copy\n        canvasCopy = null;\n      };\n\n      if (isVideo) {\n        imgData = 'data:image/png;base64,' + self.videoFeed.getImgData();\n        image.src = imgData;\n      } else {\n        var currentWindow = options.externalWindow ? options.externalWindow : window;\n        image.src = currentWindow.getComputedStyle(self.parent)['background-image'].replace(/url\\(\"|\"\\)/g, '');\n      }\n\n    };\n\n    this.onScreenCapture = function (cb) {\n      cbs.push(cb);\n    };\n\n    /**\n     * Set flags for sharing with mobile devices\n     * @param {Boolean} mobile - Is the other party using a mobile device\n     * @param {Boolean} publishing - Are we publishing our screen?\n     */\n    this.onMobileScreenShare = function (mobile, publishing) {\n      if (publishing) {\n        publishingScreenToMobileDevice = mobile;\n      } else {\n        subscribingToMobileScreen = mobile;\n      }\n    };\n\n    this.onResize = function () {\n      drawUpdates(updateHistory, true);\n      draw(null, true);\n    };\n\n    this.onClearAnnotation = function () {\n      dismissTextAnnotation();\n    };\n    /** Canvas Handling **/\n\n    function addEventListeners(el, s, fn) {\n      var evts = s.split(' ');\n      for (var i = 0, iLen = evts.length; i < iLen; i++) {\n        el.addEventListener(evts[i], fn, true);\n      }\n    }\n\n    function updateCanvas(event, resizeEvent) {\n\n      // Ensure that our canvas has been properly sized\n      if (canvas.width === 0) {\n        canvas.width = self.parent.getBoundingClientRect().width;\n      }\n\n      if (canvas.height === 0) {\n        canvas.height = self.parent.getBoundingClientRect().height;\n      }\n\n      var offsetLeft = !!resizeEvent ? event.canvas.offsetLeft : canvas.offsetLeft;\n      var offsetTop = !!resizeEvent ? event.canvas.offsetTop : canvas.offsetTop;\n\n      if (cobrowsing) {\n        var baseWidth = !!resizeEvent ? event.canvas.width : self.parent.clientWidth;\n        var baseHeight = !!resizeEvent ? event.canvas.height : self.parent.clientHeight;\n        var scaleX = canvas.width / baseWidth;\n        var scaleY = canvas.height / baseHeight;\n        var offsetX = event.offsetX || event.pageX - offsetLeft ||\n          (event.changedTouches && event.changedTouches[0].pageX - offsetLeft);\n        var offsetY = event.offsetY || event.pageY - offsetTop ||\n          (event.changedTouches && event.changedTouches[0].pageY - offsetTop);\n        var x = offsetX * scaleX;\n        var y = offsetY * scaleY;\n      } else {\n        var videoDimensions = self.videoFeed.stream.videoDimensions;\n        var scaleX = videoDimensions.width / canvas.width;\n        var scaleY = videoDimensions.height / canvas.height;\n        if (subscribingToMobileScreen) {\n          scaleX = 1;\n          scaleY = 1;\n        }\n        var offsetX = event.offsetX || event.pageX - offsetLeft ||\n          (event.changedTouches && event.changedTouches[0].pageX - offsetLeft);\n        var offsetY = event.offsetY || event.pageY - offsetTop ||\n          (event.changedTouches && event.changedTouches[0].pageY - offsetTop);\n        var x = offsetX * scaleX;\n        var y = offsetY * scaleY;\n      }\n\n      var update;\n      var selectedItem = resizeEvent ? event.selectedItem : self.selectedItem;\n\n      if (selectedItem) {\n        if (selectedItem.id === 'OT_pen') {\n\n          switch (event.type) {\n            case 'mousedown':\n            case 'touchstart':\n              client.dragging = true;\n              client.lastX = x;\n              client.lastY = y;\n              self.isStartPoint = true;\n              !resizeEvent && _log(_logEventData.actionStartDrawing, _logEventData.variationSuccess);\n              break;\n            case 'mousemove':\n            case 'touchmove':\n              if (client.dragging) {\n                update = {\n                  id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n                  fromId: self.session.connection.connectionId,\n                  fromX: client._lastX,\n                  fromY: client._lastY,\n                  toX: x,\n                  toY: y,\n                  color: resizeEvent ? event.userColor : self.userColor,\n                  lineWidth: self.lineWidth,\n                  videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n                  videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n                  canvasWidth: canvas.width,\n                  canvasHeight: canvas.height,\n                  mirrored: mirrored,\n                  startPoint: self.isStartPoint, // Each segment is treated as a new set of points\n                  endPoint: false,\n                  selectedItem: selectedItem,\n                  platform: 'web',\n                  guid: event.guid\n                };\n                draw(new VideoRelativeCoordinateSet(update), true);\n                client.lastX = x;\n                client.lastY = y;\n                !resizeEvent && sendUpdate(update);\n                self.isStartPoint = false;\n              }\n              break;\n            case 'mouseup':\n            case 'touchend':\n              client.dragging = false;\n              update = {\n                id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n                fromId: self.session.connection.connectionId,\n                fromX: client._lastX,\n                fromY: client._lastY,\n                toX: x,\n                toY: y,\n                color: resizeEvent ? event.userColor : self.userColor,\n                lineWidth: self.lineWidth,\n                videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n                videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n                canvasWidth: canvas.width,\n                canvasHeight: canvas.height,\n                mirrored: mirrored,\n                startPoint: self.isStartPoint, // Each segment is treated as a new set of points\n                endPoint: true,\n                selectedItem: selectedItem,\n                platform: 'web',\n                guid: event.guid\n              };\n              draw(new VideoRelativeCoordinateSet(update), true);\n              client.lastX = x;\n              client.lastY = y;\n              !resizeEvent && sendUpdate(update);\n              self.isStartPoint = false;\n              !resizeEvent && _log(_logEventData.actionEndDrawing, _logEventData.variationSuccess);\n              break;\n            case 'mouseout':\n              client.dragging = false;\n          }\n        } else if (selectedItem.id === 'OT_text') {\n\n          update = {\n            id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n            fromId: self.session.connection.connectionId,\n            fromX: x,\n            fromY: y + event.inputHeight, // Account for the height of the text input\n            color: event.userColor,\n            font: event.font,\n            text: event.text,\n            videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n            videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n            canvasWidth: canvas.width,\n            canvasHeight: canvas.height,\n            mirrored: mirrored,\n            selectedItem: selectedItem,\n            platform: 'web',\n            guid: event.guid\n          };\n\n          draw(new VideoRelativeCoordinateSet(update));\n          !resizeEvent && sendUpdate(update);\n        } else {\n          // We have a shape or custom object\n\n          // We are currently using a constant default width for shapes\n          var shapeLineWidth = 2;\n\n          if (selectedItem && selectedItem.points) {\n            client.mX = x;\n            client.mY = y;\n\n            switch (event.type) {\n              case 'mousedown':\n              case 'touchstart':\n                client.isDrawing = true;\n                client.dragging = true;\n                client.startX = x;\n                client.startY = y;\n                break;\n              case 'mousemove':\n              case 'touchmove':\n                if (client.dragging) {\n                  update = {\n                    color: resizeEvent ? event.userColor : self.userColor,\n                    lineWidth: resizeEvent ? event.lineWidth : shapeLineWidth,\n                    selectedItem: selectedItem\n                      // INFO The points for scaling will get added when drawing is complete\n                  };\n\n                  draw(new VideoRelativeCoordinateSet(update), true);\n                }\n                break;\n              case 'mouseup':\n              case 'touchend':\n                client.isDrawing = false;\n\n                var points = selectedItem.points;\n\n                if (points.length === 2) {\n                  update = {\n                    id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n                    fromId: self.session.connection.connectionId,\n                    fromX: client._startX,\n                    fromY: client._startY,\n                    toX: client._mX,\n                    toY: client._mY,\n                    color: resizeEvent ? event.userColor : self.userColor,\n                    lineWidth: resizeEvent ? event.lineWidth : shapeLineWidth,\n                    videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n                    videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n                    canvasWidth: canvas.width,\n                    canvasHeight: canvas.height,\n                    mirrored: mirrored,\n                    smoothed: false,\n                    startPoint: true,\n                    selectedItem: selectedItem,\n                    platform: 'web',\n                    guid: event.guid\n                  };\n\n                  drawHistory.push(new VideoRelativeCoordinateSet(update));\n\n                  !resizeEvent && sendUpdate(update);\n                } else {\n                  var scale = scaleForPoints(points);\n\n                  for (var i = 0; i < points.length; i++) {\n                    var firstPoint = false;\n                    var endPoint = false;\n\n                    // Scale the points according to the difference between the start and end points\n                    var pointX = client._startX + (scale.x * points[i][0]);\n                    var pointY = client._startY + (scale.y * points[i][1]);\n\n                    if (i === 0) {\n                      client.lastX = pointX;\n                      client.lastY = pointY;\n                      firstPoint = true;\n                    } else if (i === points.length - 1) {\n                      endPoint = true;\n                    }\n\n                    update = {\n                      id: isVideo ? self.videoFeed.stream.connection.connectionId : self.session.connection.connectionId,\n                      fromId: self.session.connection.connectionId,\n                      fromX: client._lastX,\n                      fromY: client._lastY,\n                      toX: pointX,\n                      toY: pointY,\n                      color: resizeEvent ? event.userColor : self.userColor,\n                      lineWidth: resizeEvent ? event.lineWidth : shapeLineWidth,\n                      videoWidth: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n                      videoHeight: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height,\n                      canvasWidth: canvas.width,\n                      canvasHeight: canvas.height,\n                      mirrored: mirrored,\n                      smoothed: selectedItem.enableSmoothing,\n                      startPoint: firstPoint,\n                      endPoint: endPoint,\n                      selectedItem: selectedItem,\n                      platform: 'web',\n                      guid: event.guid\n\n                    };\n\n                    drawHistory.push(new VideoRelativeCoordinateSet(update));\n\n                    !resizeEvent && sendUpdate(update);\n\n                    client.lastX = pointX; // SCALE BACK!\n                    client.lastY = pointY;\n                  }\n\n                  draw(null);\n                }\n\n                client.dragging = false;\n            }\n          }\n        }\n      }\n    }\n\n    function guid() {\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n        var r = Math.random() * 16 | 0,\n          v = c == 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n      });\n    }\n\n    addEventListeners(canvas, 'mousedown mousemove mouseup mouseout touchstart touchmove touchend', function (event) {\n\n      // Handle text annotation separately and ignore mouse movements if we're not dragging.\n      var istextEvent = self.selectedItem && self.selectedItem.id === 'OT_text';\n      var notDragging = event.type === 'mousemove' && !client.dragging;\n\n      if (istextEvent || notDragging) {\n        return;\n      }\n\n      event.preventDefault();\n\n      // Save raw events to reprocess on canvas resize\n      event.selectedItem = self.selectedItem;\n\n      if (event.selectedItem) {\n        event.canvas = {\n          width: canvas.width,\n          height: canvas.height,\n          offsetLeft: canvas.offsetLeft,\n          offsetTop: canvas.offsetTop\n        };\n\n        event.userColor = self.userColor;\n        event.lineWidth = self.lineWidth;\n        event.guid = guid();\n        eventHistory.push(event);\n      }\n\n      updateCanvas(event);\n\n    });\n\n    /**\n     * We need intermediate event handling for text annotation since the user is adding\n     * text to an input element before it is actually added to the canvas.  The original\n     * click event is assigned to textEvent, which is then updated before being passed\n     * to updateCanvas.\n     */\n\n    /** Listen for a click on the canvas.  When it occurs, append a text input\n     * that the user can edit and listen for keydown on the enter key. When enter is\n     * pressed, processTextEvent is called, the input element is removed, and the text\n     * is appended to the canvas.\n     */\n    var textEvent;\n    var textInputId = 'textAnnotation';\n    var commitPopId = 'commitTextPop';\n    var commitPopClickId = 'confirm-btn';\n    var dismissPopId = 'dismiss-btn';\n    var ignoreClicks = false;\n    var handleClick = function (event) {\n      event.preventDefault();\n\n      if (!self.selectedItem || self.selectedItem.id !== 'OT_text' || ignoreClicks) {\n        return;\n      }\n\n      ignoreClicks = true;\n\n      // Save raw events to reprocess on canvas resize\n      event.selectedItem = self.selectedItem;\n\n      createTextInput(event);\n\n    };\n\n\n    /**\n     * Get the value of the text input and use it to create an \"event\".\n     */\n    var processTextEvent = function () {\n\n      var textInput = context.getElementById(textInputId);\n      var inputheight = textInput.clientHeight;\n\n      if (!textInput.value) {\n        textEvent = null;\n        return;\n      }\n\n      textEvent.text = textInput.value;\n      textEvent.font = '16px Arial';\n      textEvent.userColor = self.userColor;\n\n      textEvent.canvas = {\n        width: canvas.width,\n        height: canvas.height,\n        offsetLeft: canvas.offsetLeft,\n        offsetTop: canvas.offsetTop\n      }\n      eventHistory.push(textEvent);\n      updateCanvas(textEvent);\n      dismissTextAnnotation();\n      ignoreClicks = false;\n    };\n\n\n    var createTextInput = function (event) {\n\n      var textInput = context.createElement('input');\n\n      textInput.setAttribute('type', 'text');\n      textInput.style.position = 'fixed';\n      textInput.style.top = event.clientY + 'px';\n      textInput.style.left = event.clientX + 'px';\n      textInput.style.background = 'rgba(255,255,255, .5)';\n      textInput.style.width = '100px';\n      textInput.style.maxWidth = '200px';\n      textInput.style.border = '1px dashed red';\n      textInput.style.fontSize = '16px';\n      textInput.style.color = self.userColor;\n      textInput.style.fontFamily = 'Arial';\n      textInput.style.zIndex = '1001';\n      textInput.setAttribute('data-canvas-origin', JSON.stringify({\n        x: event.offsetX,\n        y: event.offsetY\n      }));\n      textInput.setAttribute('data-top', event.clientY - 50)\n      textInput.id = textInputId;\n\n      context.body.appendChild(textInput);\n      textInput.focus();\n\n      textInput.addEventListener('keydown', function (event) {\n        //If its Enter\n        if (event.which === 13) {\n          creteCommitPop(textInput)\n        }\n      })\n\n      textInput.addEventListener('blur', function () {\n        creteCommitPop(textInput)\n      })\n\n      textEvent = event;\n      textEvent.inputHeight = textInput.clientHeight;\n      ignoreClicks = true;\n\n    };\n\n    var creteCommitPop = function (textInput) {\n      if (context.getElementById(commitPopId)) return;\n\n      var commitPop = context.createElement('div');\n\n      commitPop.style.position = 'fixed';\n      commitPop.style.top = textInput.dataset.top + 'px';\n      commitPop.style.left = textInput.style.left;\n      commitPop.style.width = '200px';\n      commitPop.style.fontSize = '16px';\n      commitPop.style.fontFamily = 'Arial';\n      commitPop.style.zIndex = '2000';\n      commitPop.style.border = '1px solid grey';\n      commitPop.style.height = '40px';\n      commitPop.className = 'ots-annotation-prompt';\n      commitPop.id = commitPopId;\n\n      var commitPopText = context.createElement('span');\n      var text = context.createTextNode('Commit type?');\n      commitPopText.appendChild(text);\n      commitPop.append(commitPopText)\n\n      var commitPopClick = context.createElement('div');\n      commitPopClick.id = commitPopClickId;\n      commitPopClick.className = commitPopClickId;\n\n      var dismissDiv = context.createElement('div');\n      dismissDiv.id = dismissPopId;\n      dismissDiv.className = dismissPopId;\n\n      commitPop.appendChild(commitPopClick);\n      commitPop.appendChild(dismissDiv);\n\n      context.body.appendChild(commitPop);\n\n      dismissDiv.addEventListener('click', dismissTextAnnotation);\n\n      commitPopClick.addEventListener('click', function () {\n        processTextEvent();\n      });\n    };\n\n    var dismissTextAnnotation = function () {\n      if (context.getElementById(textInputId)) context.getElementById(textInputId).remove();\n      if (context.getElementById(commitPopId)) context.getElementById(commitPopId).remove();\n      textEvent = null;\n      ignoreClicks = false;\n    }\n\n    addEventListeners(canvas, 'click', handleClick);\n\n    /**\n     * End Handle text markup\n     */\n\n    var draw = function (update, resizeEvent) {\n\n      if (!ctx) {\n        ctx = canvas.getContext('2d');\n        ctx.lineCap = 'round';\n        ctx.lineJoin = 'round';\n        ctx.fillStyle = 'solid';\n      }\n\n      // Clear the canvas\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n      // Repopulate the canvas with items from drawHistory\n      drawHistory.forEach(function (history) {\n\n        ctx.strokeStyle = history.color;\n        ctx.lineWidth = history.lineWidth;\n\n        // INFO iOS serializes bools as 0 or 1\n        history.smoothed = !!history.smoothed;\n        history.startPoint = !!history.startPoint;\n\n        var secondPoint = false;\n        var isText = history.hasOwnProperty('text');\n\n        if (isText) {\n          ctx.font = history.font;\n          ctx.fillStyle = history.color;\n          ctx.fillText(history.text, history.fromX, history.fromY);\n\n        } else {\n\n          if (history.smoothed) {\n            if (history.startPoint) {\n              self.isStartPoint = true;\n            } else {\n              // If the start point flag was already set, we received the next point in the sequence\n              if (self.isStartPoint) {\n                secondPoint = true;\n                self.isStartPoint = false;\n              }\n            }\n\n            if (history.startPoint) {\n              // Close the last path and create a new one\n              ctx.closePath();\n              ctx.beginPath();\n            } else if (secondPoint) {\n              ctx.moveTo((history.fromX + history.toX) / 2, (history.fromY + history.toY) / 2);\n            } else {\n              // console.log('Points: (' + (history.fromX + history.toX) / 2 + ', ' + (history.fromY + history.toY) / 2 + ')');\n              // console.log('Control Points: (' + history.fromX + ', ' + history.fromY + ')');\n              ctx.quadraticCurveTo(history.fromX, history.fromY, (history.fromX + history.toX) / 2, (history.fromY + history.toY) / 2);\n\n              ctx.stroke();\n            }\n          } else {\n            ctx.beginPath();\n            ctx.moveTo(history.fromX, history.fromY);\n            ctx.lineTo(history.toX, history.toY);\n            ctx.stroke();\n            ctx.closePath();\n          }\n        }\n\n      });\n\n      if (!!resizeEvent && !update) {\n        return;\n      }\n\n      var selectedItem = !!resizeEvent ? update.selectedItem : self.selectedItem;\n\n      if (selectedItem && (selectedItem.title === 'Pen' || selectedItem.title === 'Text')) {\n\n        if (update) {\n\n          if (selectedItem.title === 'Pen') {\n            ctx.strokeStyle = update.color;\n            ctx.lineWidth = update.lineWidth;\n            ctx.beginPath();\n            ctx.moveTo(update.fromX, update.fromY);\n            ctx.lineTo(update.toX, update.toY);\n            ctx.stroke();\n            ctx.closePath();\n          }\n\n          if (selectedItem.title === 'Text') {\n            ctx.font = update.font;\n            ctx.fillStyle = update.color;\n            ctx.fillText(update.text, update.fromX, update.fromY);\n          }\n\n          drawHistory.push(update);\n        }\n      } else {\n        if (client.isDrawing) {\n          if (update) {\n            ctx.strokeStyle = update.color;\n            ctx.lineWidth = update.lineWidth;\n          }\n          if (selectedItem && selectedItem.points) {\n            drawPoints(ctx, self.selectedItem.points);\n          }\n        }\n      }\n    };\n\n    var drawPoints = function (ctx, points) {\n      var scale = scaleForPoints(points);\n\n      ctx.beginPath();\n\n      if (points.length === 2) {\n        // We have a line\n        ctx.moveTo(client.startX, client.startY);\n        ctx.lineTo(client.mX, client.mY);\n      } else {\n        for (var i = 0; i < points.length; i++) {\n          // Scale the points according to the difference between the start and end points\n          // Use device independent points here!\n          client.pointX = client._startX + (scale.x * points[i][0]);\n          client.pointY = client._startY + (scale.y * points[i][1]);\n\n          if (self.selectedItem.enableSmoothing) {\n            if (i === 0) {\n              // Do nothing\n            } else if (i === 1) {\n              ctx.moveTo((client.pointX + client.lastX) / 2, (client.pointY + client.lastY) / 2);\n              client.lastX = (client._pointX + client._lastX) / 2;\n              client.lastX = (client._pointY + client._lastY) / 2;\n            } else {\n              ctx.quadraticCurveTo(client.lastX, client.lastY, (client.pointX + client.lastX) / 2,\n                (client.pointY + client.lastY) / 2);\n              client.lastX = (client._pointX + client._lastX) / 2;\n              client.lastY = (client._pointY + client._lastY) / 2;\n            }\n          } else {\n            if (i === 0) {\n              ctx.moveTo(client.pointX, client.pointY);\n            } else {\n              ctx.lineTo(client.pointX, client.pointY);\n            }\n          }\n\n          client.lastX = client._pointX; // SCALE BACK!\n          client.lastY = client._pointY;\n        }\n      }\n\n      ctx.stroke();\n      ctx.closePath();\n    };\n\n    var scaleForPoints = function (points) {\n      // mX and mY refer to the end point of the enclosing rectangle (touch up)\n      var minX = Number.MAX_VALUE;\n      var minY = Number.MAX_VALUE;\n      var maxX = 0;\n      var maxY = 0;\n      for (var i = 0; i < points.length; i++) {\n        if (points[i][0] < minX) {\n          minX = points[i][0];\n        } else if (points[i][0] > maxX) {\n          maxX = points[i][0];\n        }\n\n        if (points[i][1] < minY) {\n          minY = points[i][1];\n        } else if (points[i][1] > maxY) {\n          maxY = points[i][1];\n        }\n      }\n      var dx = Math.abs(maxX - minX);\n      var dy = Math.abs(maxY - minY);\n\n      var scaleX = (client._mX - client._startX) / dx;\n      var scaleY = (client._mY - client._startY) / dy;\n\n      return {\n        x: scaleX,\n        y: scaleY\n      };\n    };\n\n    var drawIncoming = function (update, resizeEvent, index) {\n\n      var iCanvas = {\n        width: update.canvasWidth,\n        height: update.canvasHeight\n      };\n\n      var iVideo = {\n        width: update.videoWidth,\n        height: update.videoHeight\n      };\n\n      var video = {\n        width: isVideo ? self.videoFeed.videoElement().clientWidth : canvas.width,\n        height: isVideo ? self.videoFeed.videoElement().clientHeight : canvas.height\n      };\n\n      // INFO iOS serializes bools as 0 or 1\n      update.mirrored = !!update.mirrored;\n\n      // Check if the incoming signal was mirrored\n      if (update.mirrored) {\n        update.fromX = video.width - update.fromX;\n        update.toX = video.width - update.toX;\n      }\n\n      // Check to see if the active video feed is also mirrored (double negative)\n      if (mirrored) {\n        // Revert (Double negative)\n        update.fromX = video.width - update.fromX;\n        update.toX = video.width - update.toX;\n      }\n\n\n      /** Keep history of updates for resize */\n      var updateForHistory = JSON.parse(JSON.stringify(update));\n      updateForHistory.canvasWidth = canvas.width;\n      updateForHistory.canvasHeight = canvas.height;\n      updateForHistory.videoWidth = video.width;\n      updateForHistory.videoHeight = video.height;\n\n      if (resizeEvent) {\n        updateHistory[index] = updateForHistory;\n      } else {\n        updateHistory.push(updateForHistory);\n        drawHistory.push(new VideoRelativeCoordinateSet(update));\n      }\n      /** ********************************** */\n\n      draw(null);\n    };\n\n    var drawUpdates = function (updates, resizeEvent) {\n\n      updates.forEach(function (update, index) {\n        if (!isVideo || (self.videoFeed && self.videoFeed.stream && update.id === self.videoFeed.stream.connection.connectionId)) {\n          drawIncoming(update, resizeEvent, index);\n        }\n      });\n    };\n\n    var clearCanvas = function (incoming, cid) {\n      // console.log('cid: ' + cid);\n      // Remove all elements from history that were drawn by the sender\n\n      drawHistory = drawHistory.filter(function (history) {\n        return history.fromId !== cid;\n      });\n\n      if (!incoming) {\n        if (self.session) {\n          self.session.signal({\n            type: 'otAnnotation_clear'\n          });\n        }\n        eventHistory = [];\n      } else {\n        updateHistory = [];\n      }\n\n\n      // Refresh the canvas\n      draw();\n    };\n\n    var undoLast = function (incoming, cid, itemsToRemove) {\n\n      var historyItem;\n      var removed;\n      var endPoint = false;\n      var removedItems = [];\n      for (var i = drawHistory.length - 1; i >= 0; i--) {\n        historyItem = drawHistory[i];\n        if (historyItem.fromId === cid) {\n\n          if (historyItem.platform === 'ios' && !!itemsToRemove && !!itemsToRemove.length && itemsToRemove[0] !== null) {\n            undoLastIos(incoming, cid, itemsToRemove);\n            break;\n          }\n\n          endPoint = endPoint || historyItem.endPoint;\n          removed = drawHistory.splice(i, 1)[0];\n          removedItems.push(removed.guid);\n          if (!endPoint || (endPoint && removed.startPoint === true)) {\n            break;\n          }\n        }\n      }\n\n      if (incoming) {\n        updateHistory = updateHistory.filter(function (history) {\n          return !itemsToRemove.includes(history.guid);\n        });\n      } else {\n        eventHistory = eventHistory.filter(function (history) {\n          return !removedItems.includes(history.guid);\n        });\n\n        self.session.signal({\n          type: 'otAnnotation_undo',\n          data: JSON.stringify(removedItems)\n        });\n      }\n\n      draw();\n    }\n\n    var undoLastIos = function (incoming, cid, itemsToRemove) {\n\n      var historyItem;\n      var removed;\n      var endPoint = false;\n      var removedItems = [];\n\n\n      for (var i = drawHistory.length - 1; i >= 0; i--) {\n        historyItem = drawHistory[i];\n        if (historyItem.fromId === cid) {\n          if (historyItem.guid === itemsToRemove[0]) {\n            removed = drawHistory.splice(i, 1)[0];\n            removedItems.push(removed.guid);\n          }\n        }\n      }\n\n      if (incoming) {\n        updateHistory = updateHistory.filter(function (history) {\n          return !itemsToRemove.includes(history.guid);\n        });\n      } else {\n        eventHistory = eventHistory.filter(function (history) {\n          return !removedItems.includes(history.guid);\n        });\n\n        self.session.signal({\n          type: 'otAnnotation_undo',\n          data: JSON.stringify(removedItems)\n        });\n      }\n\n      draw();\n    }\n\n\n    var count = 0;\n    /** Signal Handling **/\n    if (_session) {\n      _session.on({\n        'signal:otAnnotation_pen': function (event) {\n          if (event.from.connectionId !== _session.connection.connectionId) {\n            var paths = JSON.parse(event.data);\n            drawUpdates(paths);\n          }\n        },\n        'signal:otAnnotation_text': function (event) {\n          if (event.from.connectionId !== _session.connection.connectionId) {\n            drawUpdates(JSON.parse(event.data));\n          }\n        },\n        'signal:otAnnotation_history': function (event) {\n          // We will receive these from everyone in the room, only listen to the first\n          // person. Also the data is chunked together so we need all of that person's\n          if (!drawHistoryReceivedFrom || drawHistoryReceivedFrom === event.from.connectionId) {\n            drawHistoryReceivedFrom = event.from.connectionId;\n            drawUpdates(JSON.parse(event.data));\n          }\n        },\n        'signal:otAnnotation_clear': function (event) {\n          if (event.from.connectionId !== _session.connection.connectionId) {\n            // Only clear elements drawn by the sender's (from) Id\n            clearCanvas(true, event.from.connectionId);\n          }\n        },\n        'signal:otAnnotation_undo': function (event) {\n          if (event.from.connectionId !== _session.connection.connectionId) {\n            // Only clear elements drawn by the sender's (from) Id\n            undoLast(true, event.from.connectionId, JSON.parse(event.data));\n          }\n        },\n        connectionCreated: function (event) {\n          if (drawHistory.length > 0 && event.connection.connectionId !== _session.connection.connectionId) {\n            batchSignal('otWhiteboard_history', drawHistory, event.connection);\n          }\n        }\n      });\n    }\n\n    var batchSignal = function (data, toConnection) {\n\n      var signalError = function (err) {\n        if (err) {\n          TB.error(err);\n        }\n      };\n\n      var type = 'otAnnotation_pen';\n      var updateType = function (chunk) {\n        if (!chunk || !chunk[0] || !chunk[0].selectedItem || !chunk[0].selectedItem.id) {\n          return;\n        }\n        var id = chunk[0].selectedItem.id;\n        type = id === 'OT_text' ? 'otAnnotation_text' : 'otAnnotation_pen';\n      };\n\n      /**\n       * If the 'type' string exceeds the maximum length (128 bytes), or the\n       * 'data' string exceeds the maximum size (8 kB), OT will return a 413 error\n       * and the signal will not be sent.  The maximum number of characters that\n       * can be sent in the signal is 8,192.  Currently, the largest updates are\n       * 995 characters, meaning that the limit for the number of updates per\n       * signal should be 8, even taking into account the additional characters\n       * required to convert the entire array of updates as opposed to each one\n       * individually.  However, OT is throwing a 413 error once the size exceeds\n       * 7,900 characters. So, 7 is the magic number for the time being.\n       * UPDATE: At 7, we're still seeing errors.  So, 6 it is.\n       */\n      var dataChunk;\n      var start = 0;\n      var updatesPerSignal = 6;\n      while (start < data.length) {\n        dataChunk = data.slice(start, start + updatesPerSignal);\n        updateType(dataChunk);\n        start += updatesPerSignal;\n        var signal = {\n          type: type,\n          data: JSON.stringify(dataChunk)\n        };\n        if (toConnection) {\n          signal.to = toConnection;\n        }\n        self.session.signal(signal, signalError);\n      }\n    };\n\n    var updateTimeout;\n    var sendUpdate = function (update) {\n      if (self.session) {\n        batchUpdates.push(update);\n        if (!updateTimeout) {\n          updateTimeout = setTimeout(function () {\n            batchSignal(batchUpdates);\n            batchUpdates = [];\n            updateTimeout = null;\n          }, 100);\n        }\n      }\n    };\n  };\n\n  //--------------------------------------\n  //  OPENTOK ANNOTATION TOOLBAR\n  //--------------------------------------\n\n  OTSolution.Annotations.Toolbar = function (options) {\n    var self = this;\n    var _toolbar = this;\n\n    options || (options = {});\n\n    if (!options.session) {\n      throw new Error('OpenTok Annotation Widget requires an OpenTok session');\n    } else {\n      _session = options.session;\n    }\n\n    if (!_OTKAnalytics && !options.OTKAnalytics) {\n      throw new Error('OpenTok Annotation Widget requires an OpenTok Solution');\n    } else {\n      _OTKAnalytics = _OTKAnalytics || options.OTKAnalytics;\n\n    }\n\n    if (!_otkanalytics) {\n      _logAnalytics();\n    }\n\n    this.session = options.session;\n    this.parent = options.container;\n    this.externalWindow = options.externalWindow;\n    // TODO Allow 'style' objects to be passed in for buttons, menu toolbar, etc?\n    this.backgroundColor = options.backgroundColor || 'rgba(102, 102, 102, 0.90)';\n    this.subpanelBackgroundColor = options.subpanelBackgroundColor || '#323232';\n\n    var imageAssets = options.imageAssets || DEFAULT_ASSET_URL;\n\n    var toolbarItems = [{\n        id: 'OT_pen',\n        title: 'Pen',\n        icon: [imageAssets, 'annotation-pencil.png'].join(''),\n        selectedIcon: [imageAssets, 'annotation-pencil.png'].join(''),\n        items: { /* Built dynamically */ }\n      }, {\n        id: 'OT_colors',\n        title: 'Colors',\n        icon: '',\n        items: { /* Built dynamically */ }\n      }, {\n        id: 'OT_shapes',\n        title: 'Shapes',\n        icon: [imageAssets, 'annotation-shapes.png'].join(''),\n        items: [{\n            id: 'OT_rect',\n            title: 'Rectangle',\n            icon: [imageAssets, 'annotation-rectangle.png'].join(''),\n            points: [\n              [0, 0],\n              [1, 0],\n              [1, 1],\n              [0, 1],\n              [0, 0] // Reconnect point\n            ]\n          },\n          {\n            id: 'OT_rect_fill',\n            title: 'Rectangle-Fill',\n            icon: [imageAssets, 'annotation-rectangle.png'].join(''),\n            points: [\n              [0, 0],\n              [1, 0],\n              [1, 1],\n              [0, 1],\n              [0, 0] // Reconnect point\n            ]\n          }, {\n            id: 'OT_oval',\n            title: 'Oval',\n            icon: [imageAssets, 'annotation-oval.png'].join(''),\n            enableSmoothing: true,\n            points: [\n              [0, 0.5],\n              [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)],\n              [0.5, 0],\n              [0.5 + 0.5 * Math.cos(7 * Math.PI / 4), 0.5 + 0.5 * Math.sin(7 * Math.PI / 4)],\n              [1, 0.5],\n              [0.5 + 0.5 * Math.cos(Math.PI / 4), 0.5 + 0.5 * Math.sin(Math.PI / 4)],\n              [0.5, 1],\n              [0.5 + 0.5 * Math.cos(3 * Math.PI / 4), 0.5 + 0.5 * Math.sin(3 * Math.PI / 4)],\n              [0, 0.5],\n              [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)]\n            ]\n          }, {\n            id: 'OT_oval_fill',\n            title: 'Oval-Fill',\n            icon: [imageAssets, 'annotation-oval-fill.png'].join(''),\n            enableSmoothing: true,\n            points: [\n              [0, 0.5],\n              [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)],\n              [0.5, 0],\n              [0.5 + 0.5 * Math.cos(7 * Math.PI / 4), 0.5 + 0.5 * Math.sin(7 * Math.PI / 4)],\n              [1, 0.5],\n              [0.5 + 0.5 * Math.cos(Math.PI / 4), 0.5 + 0.5 * Math.sin(Math.PI / 4)],\n              [0.5, 1],\n              [0.5 + 0.5 * Math.cos(3 * Math.PI / 4), 0.5 + 0.5 * Math.sin(3 * Math.PI / 4)],\n              [0, 0.5],\n              [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)]\n            ]\n          }, {\n            id: 'OT_star',\n            title: 'Star',\n            icon: [imageAssets, 'annotation-star.png'].join(''),\n            points: [\n              /* eslint-disable max-len */\n              [0.5 + 0.5 * Math.cos(90 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(90 * (Math.PI / 180))],\n              [0.5 + 0.25 * Math.cos(126 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(126 * (Math.PI / 180))],\n              [0.5 + 0.5 * Math.cos(162 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(162 * (Math.PI / 180))],\n              [0.5 + 0.25 * Math.cos(198 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(198 * (Math.PI / 180))],\n              [0.5 + 0.5 * Math.cos(234 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(234 * (Math.PI / 180))],\n              [0.5 + 0.25 * Math.cos(270 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(270 * (Math.PI / 180))],\n              [0.5 + 0.5 * Math.cos(306 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(306 * (Math.PI / 180))],\n              [0.5 + 0.25 * Math.cos(342 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(342 * (Math.PI / 180))],\n              [0.5 + 0.5 * Math.cos(18 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(18 * (Math.PI / 180))],\n              [0.5 + 0.25 * Math.cos(54 * (Math.PI / 180)), 0.5 + 0.25 * Math.sin(54 * (Math.PI / 180))],\n              [0.5 + 0.5 * Math.cos(90 * (Math.PI / 180)), 0.5 + 0.5 * Math.sin(90 * (Math.PI / 180))]\n              /* eslint-enable max-len */\n            ]\n          }, {\n            id: 'OT_arrow',\n            title: 'Arrow',\n            icon: [imageAssets, 'annotation-arrow.png'].join(''),\n            points: [\n              [0, 1],\n              [3, 1],\n              [3, 0],\n              [5, 2],\n              [3, 4],\n              [3, 3],\n              [0, 3],\n              [0, 1] // Reconnect point\n            ]\n          }, {\n            id: 'OT_line',\n            title: 'Line',\n            icon: [imageAssets, 'annotation-line.png'].join(''),\n            selectedIcon: [imageAssets, 'annotation-line.png'].join(''),\n            points: [\n              [0, 0],\n              [0, 1]\n            ]\n          }\n        ]\n      }, {\n        id: 'OT_text',\n        title: 'Text',\n        icon: [imageAssets, 'annotation-text.png'].join(''),\n        selectedIcon: [imageAssets, 'annotation-text.png'].join('')\n      }, {\n        id: 'OT_capture',\n        title: 'Capture',\n        icon: [imageAssets, 'annotation-camera.png'].join(''),\n        selectedIcon: [imageAssets, 'annotation-camera.png'].join('')\n      }, {\n        id: 'OT_undo',\n        title: 'Undo',\n        icon: [imageAssets, 'annotation-undo.png'].join('')\n      },\n      {\n        id: 'OT_clear',\n        title: 'Clear',\n        icon: [imageAssets, 'annotation-clear.png'].join('')\n      }\n    ];\n\n\n    /**\n     * If we recieve items as part of the options hash, build the toolbar from the list of items.\n     * Otherwise, include all items.\n     */\n    var getItems = function () {\n      var itemNames = ['pen', 'colors', 'shapes', 'text', 'capture', 'undo', 'clear'];\n      var shapeNames = ['rectangle', 'rectangle-fill', 'oval', 'oval-fill', 'star', 'arrow', 'line'];\n      var addItem = function (acc, item) {\n        var index = itemNames.indexOf(item);\n        if (index !== -1) {\n          var toolbarItem = toolbarItems[index];\n          if (toolbarItem.title === 'Shapes' && !!options.shapes) {\n            var shapes = options.shapes.reduce(function (shapeAcc, shape) {\n              var shapeIndex = shapeNames.indexOf(shape);\n              return shapeIndex !== -1 ? shapeAcc.concat(toolbarItem.items[shapeIndex]) : shapeAcc;\n            }, []);\n            toolbarItem.items = shapes;\n          }\n          acc.push(toolbarItem);\n        }\n        return acc;\n      }\n\n      if (!!options.items && !!options.items.length) {\n        var itemsToBuild = options.items[0] === '*' ? itemNames : options.items;\n        return itemsToBuild.reduce(addItem, []);\n      } else {\n        return toolbarItems;\n      }\n    }\n\n    this.items = getItems();\n\n    this.colors = options.colors || [\n      '#1abc9c',\n      '#2ecc71',\n      '#3498db',\n      '#9b59b6',\n      '#34495e',\n      '#16a085',\n      '#27ae60',\n      '#2980b9',\n      '#8e44ad',\n      '#2c3e50',\n      '#f1c40f',\n      '#e67e22',\n      '#e74c3c',\n      '#ecf0f1',\n      '#95a5a6',\n      '#f39c12',\n      '#d35400',\n      '#c0392b',\n      '#bdc3c7',\n      '#7f8c8d'\n    ];\n\n    this.cbs = [];\n    var canvases = [];\n\n    /**\n     * Creates a sub-menu with a color picker.\n     *\n     * @param {String|Element} parent The parent div container for the color picker sub-menu.\n     * @param {Array} colors The array of colors to add to the palette.\n     * @param {Object} options options An object containing the following fields:\n     *\n     *  - `openEvent` (String): The open event (default: `\"click\"`).\n     *  - `style` (Object): Some style options:\n     *    - `display` (String): The display value when the picker is opened (default: `\"block\"`).\n     *  - `template` (String): The color item template. The `{color}` snippet will be replaced\n     *    with the color value (default: `\"<div data-col=\\\"{color}\\\" style=\\\"background-color: {color}\\\"></div>\"`).\n     *  - `autoclose` (Boolean): If `false`, the color picker will not be hidden by default (default: `true`).\n     *\n     * @constructor\n     */\n    var ColorPicker = function (parent, colors, options) {\n      var self = this;\n      var context = _toolbar.externalWindow ? _toolbar.externalWindow.document : document;\n\n      this.getElm = function (el, all) {\n        if (typeof el === 'string') {\n          return all ? context.querySelectorAll(el) : context.querySelector(el);\n        }\n        return el;\n      };\n\n      this.render = function () {\n        var self = this,\n          html = '';\n\n        self.colors.forEach(function (c) {\n          html += self.options.template.replace(/\\{color\\}/g, c);\n        });\n\n        self.elm.innerHTML = html;\n      };\n\n      this.close = function () {\n        // this.elm.style.display = 'none';\n        this.elm.classList.add('ots-hidden');\n      };\n\n      this.open = function () {\n        // this.elm.style.display = this.options.style.display;\n        this.elm.classList.remove('ots-hidden')\n\n      };\n\n      this.colorChosen = function (cb) {\n        this.cbs.push(cb);\n      };\n\n      this.set = function (c, p) {\n        var self = this;\n        self.color = c;\n        if (p === false) {\n          return;\n        }\n        self.cbs.forEach(function (cb) {\n          cb.call(self, c);\n        });\n      };\n\n      options = options || {};\n      options.openEvent = options.openEvent || 'click';\n      options.style = Object(options.style);\n      // options.style.display = options.style.display || 'block';\n      options.template = options.template || '<div class=\\\"color-choice\\\" data-col=\\\"{color}\\\" style=\\\"background-color: {color}\\\"></div>';\n      self.elm = self.getElm(parent);\n      self.cbs = [];\n      self.colors = colors;\n      self.options = options;\n      self.render();\n\n      // Click on colors\n      self.elm.addEventListener('click', function (ev) {\n        var color = ev.target.getAttribute('data-col');\n        if (!color) {\n          return;\n        }\n        var colors = Array.from(self.getElm('.color-choice', true));\n        colors.forEach(function (el) {\n          el.classList.remove('active');\n        });\n        ev.target.classList.add('active');\n        self.set(color);\n        self.close();\n      });\n\n      if (options.autoclose !== false) {\n        self.close();\n      }\n    };\n\n    var panel;\n    this.createPanel = function (externalWindow) {\n      if (_toolbar.parent) {\n        var context = externalWindow ? externalWindow.document : document;\n        panel = context.createElement('div');\n        panel.setAttribute('id', 'OT_toolbar');\n        panel.setAttribute('class', 'OT_panel');\n        panel.style.width = '100%';\n        panel.style.height = '100%';\n        this.parent.appendChild(panel);\n        this.parent.style.position = 'relative';\n        this.parent.zIndex = 1000;\n\n        var toolbarItems = [];\n        var subPanel = context.createElement('div');\n\n        for (var i = 0, total = this.items.length; i < total; i++) {\n          var item = this.items[i];\n\n          var button = context.createElement('input');\n          button.setAttribute('type', 'button');\n          button.setAttribute('id', item.id);\n          button.classList.add('annotation-btn');\n          button.classList.add(item.title.split(' ').join('-').toLowerCase());\n\n          if (item.id === 'OT_colors') {\n\n            var colorPicker = context.createElement('div');\n            colorPicker.setAttribute('class', 'color-picker');\n            // colorPicker.style.backgroundColor = this.subpanelBackgroundColor;\n            this.parent.appendChild(colorPicker);\n\n            var pk = new ColorPicker('.color-picker', this.colors, {\n              externalWindow: _toolbar.externalWindow\n            });\n\n            pk.colorChosen(function (color) {\n              var colorGroup = context.getElementById('OT_colors');\n              colorGroup.style.backgroundColor = color;\n\n              canvases.forEach(function (canvas) {\n                canvas.changeColor(color);\n              });\n            });\n\n            var colorChoices = context.querySelectorAll('.color-choice');\n            colorChoices[0].classList.add('active');\n            button.setAttribute('class', 'OT_color annotation-btn colors');\n            button.style.borderRadius = '50%';\n            button.style.backgroundColor = this.colors[0];\n\n          }\n\n          if (item.title === 'Pen' && !Array.isArray(item.items)) {\n            // Add defaults\n            item.items = [{\n              id: 'OT_line_width_2',\n              title: 'Line Width 2',\n              size: 2\n            }, {\n              id: 'OT_line_width_4',\n              title: 'Line Width 4',\n              size: 4\n            }, {\n              id: 'OT_line_width_6',\n              title: 'Line Width 6',\n              size: 6\n            }, {\n              id: 'OT_line_width_8',\n              title: 'Line Width 8',\n              size: 8\n            }, {\n              id: 'OT_line_width_10',\n              title: 'Line Width 10',\n              size: 10\n            }, {\n              id: 'OT_line_width_12',\n              title: 'Line Width 12',\n              size: 12\n            }, {\n              id: 'OT_line_width_14',\n              title: 'Line Width 14',\n              size: 14\n            }];\n          }\n\n          if (item.items) {\n            // Indicate that we have a group\n            button.setAttribute('data-type', 'group');\n          }\n\n          button.setAttribute('data-col', item.title);\n\n\n          toolbarItems.push(button.outerHTML);\n        }\n\n        panel.innerHTML = toolbarItems.join('');\n\n        /**\n         * Since the color picker button uses its background to display the\n         * current color, we need to add a pseudo-element element to the toolbar\n         * to simulate hover state on the button.  When the user hovers over the\n         * button, we add the 'colors-hover' class to 'OT_toolbar' which has a\n         * pseudo-element which makes it seem as though the color picker button\n         * background is changing.\n         * TODO: Update the color picker and color choices to display colors\n         *       using pseudo-elements, so that we can more easily apply hover\n         *       states.\n         */\n        var toggleColorsHover = function (hover) {\n          var action = hover ? 'add' : 'remove';\n          document.getElementById('OT_toolbar').classList[action]('colors-hover');\n        };\n        var colors = context.getElementById('OT_colors');\n        colors.addEventListener('mouseenter', function () {\n          toggleColorsHover(true);\n        });\n        colors.addEventListener('mouseleave', function () {\n          toggleColorsHover(false);\n        });\n        /** End color picker hover state */\n\n        panel.onclick = function (ev) {\n          var group = ev.target.getAttribute('data-type') === 'group';\n          var itemName = ev.target.getAttribute('data-col');\n          var id = ev.target.getAttribute('id');\n\n\n          // Close the submenu if we are clicking on an item and not a group button\n          if (!group) {\n            self.items.forEach(function (item) {\n              if ((item.title !== 'Clear' || item.title !== 'Undo') && item.title === itemName) {\n\n                self.selectedItem = item;\n\n                attachDefaultAction(item);\n\n                canvases.forEach(function (canvas) {\n                  canvas.selectItem(self.selectedItem);\n                });\n\n                return false;\n              }\n            });\n            subPanel.classList.add('ots-hidden')\n          } else {\n            self.items.forEach(function (item) {\n              if (item.title === itemName) {\n                self.selectedGroup = item;\n\n                if (item.items) {\n                  subPanel.setAttribute('class', ['OT_subpanel', 'ots-hidden', item.title.toLowerCase()].join(' '));\n\n                  self.parent.appendChild(subPanel);\n\n                  if (Array.isArray(item.items)) {\n                    var submenuItems = [];\n\n                    if (item.id === 'OT_pen') {\n                      // We want to dynamically create icons for the list of possible line widths\n                      item.items.forEach(function (subItem) {\n                        // INFO Using a div here - not input to create an inner div representing the line width - better option?\n                        var itemButton = context.createElement('div');\n                        itemButton.setAttribute('data-col', subItem.title);\n                        itemButton.setAttribute('class', ['line-width-option', subItem.size].join(' '));\n                        itemButton.setAttribute('id', subItem.id);\n\n                        var lineIcon = context.createElement('div');\n                        lineIcon.setAttribute('class', 'line-width-icon')\n                          // TODO Allow devs to change this?\n                        lineIcon.style.backgroundColor = '#FFFFFF';\n                        lineIcon.style.width = '80%';\n                        lineIcon.style.height = subItem.size + 'px';\n                        lineIcon.style.position = 'relative';\n                        lineIcon.style.left = '50%';\n                        lineIcon.style.top = '50%';\n                        lineIcon.style.transform = 'translateX(-50%) translateY(-50%)';\n                        // Prevents div icon from catching events so they can be passed to the parent\n                        lineIcon.style.pointerEvents = 'none';\n\n                        itemButton.appendChild(lineIcon);\n\n                        submenuItems.push(itemButton.outerHTML);\n                      });\n                    } else {\n                      item.items.forEach(function (subItem) {\n                        var itemButton = context.createElement('input');\n                        itemButton.setAttribute('type', 'button');\n                        itemButton.setAttribute('data-col', subItem.title);\n                        itemButton.setAttribute('id', subItem.id);\n                        itemButton.setAttribute('class', ['annotation-btn', subItem.title.toLowerCase()].join(' '));\n                        // itemButton.style.backgroundImage = 'url(\"' + subItem.icon + '\")';\n                        // itemButton.style.position = 'relative';\n                        // itemButton.style.top = '50%';\n                        // itemButton.style.transform = 'translateY(-50%)';\n                        // itemButton.style.backgroundSize = self.iconWidth + ' ' + self.iconHeight;\n                        // itemButton.style.backgroundPosition = 'center';\n                        // itemButton.style.width = self.buttonWidth;\n                        // itemButton.style.height = self.buttonHeight;\n                        // itemButton.style.border = 'none';\n                        // itemButton.style.cursor = 'pointer';\n\n                        submenuItems.push(itemButton.outerHTML);\n                      });\n                    }\n\n                    subPanel.innerHTML = submenuItems.join('');\n                  }\n                }\n\n                if (id === 'OT_shapes' || id === 'OT_pen') {\n                  if (subPanel) {\n                    subPanel.classList.remove('ots-hidden');\n                  }\n                  pk.close();\n                } else if (id === 'OT_colors') {\n                  if (subPanel) {\n                    subPanel.classList.add('ots-hidden');\n                  }\n                  pk.open();\n                }\n              }\n            });\n          }\n\n          self.cbs.forEach(function (cb) {\n            cb.call(self, id);\n          });\n        };\n\n        subPanel.onclick = function (ev) {\n          var group = ev.target.getAttribute('data-type') === 'group';\n          var itemName = ev.target.getAttribute('data-col');\n          var id = ev.target.getAttribute('id');\n\n\n          if (!!id && id.replace(/[^a-z]/g, '') === 'linewidth') {\n            canvases.forEach(function (canvas) {\n              canvas.selectItem(self.selectedGroup);\n            });\n          }\n\n          subPanel.classList.add('ots-hidden');\n\n          if (!group) {\n            self.selectedGroup.items.forEach(function (item) {\n              if (item.id !== 'OT_clear' && item.id === id) {\n                if (self.selectedItem) {\n                  var lastBtn = document.getElementById(self.selectedItem.id);\n                  if (lastBtn) {\n                    // lastBtn.style.background = 'url(\"' + self.selectedItem.icon + '\") no-repeat';\n                    // lastBtn.style.backgroundSize = self.iconWidth + ' ' + self.iconHeight;\n                    // lastBtn.style.backgroundPosition = 'center';\n                  }\n                }\n\n                if (item.selectedIcon) {\n                  var selBtn = document.getElementById(item.id);\n                  if (lastBtn) {\n                    selBtn.style.background = 'url(\"' + item.selectedIcon + '\") no-repeat';\n                    selBtn.style.backgroundSize = self.iconWidth + ' ' + self.iconHeight;\n                    selBtn.style.backgroundPosition = 'center';\n                  }\n                }\n\n                self.selectedItem = item;\n\n                attachDefaultAction(item);\n\n                canvases.forEach(function (canvas) {\n                  canvas.selectItem(self.selectedItem);\n                });\n\n                return false;\n              }\n            });\n          }\n\n          self.cbs.forEach(function (cb) {\n            cb.call(self, id);\n          });\n        };\n\n        var onClear = context.getElementById('OT_clear').onclick = function () {\n          canvases.forEach(function (canvas) {\n            canvas.clear();\n          });\n        };\n\n        context.getElementById('OT_undo').onclick = function () {\n          canvases.forEach(function (canvas) {\n            canvas.undo();\n          });\n        };\n\n        window.addEventListener('OT_clear', function () {\n          onClear();\n          self.selectedItem = null;\n          canvases.forEach(function (canvas) {\n            canvas.selectItem(self.selectedItem);\n          });\n        });\n\n        window.addEventListener('OT_pen', function (evt) {\n          var item = self.items.find(function (item) {\n            return item.id === 'OT_pen';\n          });\n\n          self.selectedItem = item;\n          attachDefaultAction(item);\n          var color = evt.detail.color;\n          canvases.forEach(function (canvas) {\n            canvas.selectItem(self.selectedItem);\n            color && canvas.changeColor(color);\n          });\n        });\n      }\n    };\n\n    !this.externalWindow && this.createPanel();\n\n    var attachDefaultAction = function (item) {\n      if (!item.points) {\n        // Attach default actions\n        if (item.id === 'OT_line') {\n          self.selectedItem.points = [\n            [0, 0],\n            [0, 1]\n          ];\n        } else if (item.id === 'OT_arrow') {\n          self.selectedItem.points = [\n            [0, 1],\n            [3, 1],\n            [3, 0],\n            [5, 2],\n            [3, 4],\n            [3, 3],\n            [0, 3],\n            [0, 1] // Reconnect point\n          ];\n        } else if (item.id === 'OT_rect') {\n          self.selectedItem.points = [\n            [0, 0],\n            [1, 0],\n            [1, 1],\n            [0, 1],\n            [0, 0] // Reconnect point\n          ];\n        } else if (item.id === 'OT_oval') {\n          self.selectedItem.enableSmoothing = true;\n          self.selectedItem.points = [\n            [0, 0.5],\n            [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)],\n            [0.5, 0],\n            [0.5 + 0.5 * Math.cos(7 * Math.PI / 4), 0.5 + 0.5 * Math.sin(7 * Math.PI / 4)],\n            [1, 0.5],\n            [0.5 + 0.5 * Math.cos(Math.PI / 4), 0.5 + 0.5 * Math.sin(Math.PI / 4)],\n            [0.5, 1],\n            [0.5 + 0.5 * Math.cos(3 * Math.PI / 4), 0.5 + 0.5 * Math.sin(3 * Math.PI / 4)],\n            [0, 0.5],\n            [0.5 + 0.5 * Math.cos(5 * Math.PI / 4), 0.5 + 0.5 * Math.sin(5 * Math.PI / 4)]\n          ];\n        }\n      }\n    };\n\n    /**\n     * Callback function for toolbar menu item click events.\n     * @param cb The callback function used to handle the click event.\n     */\n    this.itemClicked = function (cb) {\n      this.cbs.push(cb);\n    };\n\n    /**\n     * Links an annotation canvas to the toolbar so that menu actions can be handled on it.\n     * @param canvas The annotation canvas to be linked to the toolbar.\n     * @param externalWindow External screen sharing window\n     */\n    this.addCanvas = function (canvas, externalWindow) {\n      var self = this;\n      var context = externalWindow ? externalWindow.document : document;\n      canvas.link(self.session);\n      canvas.colors(self.colors);\n      canvases.push(canvas);\n      canvases.forEach(function (canvas) {\n        canvas.selectedItem = canvas.selectedItem || self.items[0];\n        context.getElementById(canvas.selectedItem.id).classList.add('selected');\n      });\n    };\n\n    /**\n     * Removes the annotation canvas with the specified connectionId from its parent container and\n     * unlinks it from the toolbar.\n     * @param connectionId The stream's connection ID for the video feed whose canvas should be removed.\n     */\n    this.removeCanvas = function (connectionId) {\n      canvases.forEach(function (annotationView) {\n        var canvas = annotationView.canvas();\n        if (annotationView.videoFeed.stream.connection.connectionId === connectionId) {\n          if (canvas.parentNode) {\n            canvas.parentNode.removeChild(canvas);\n          }\n        }\n      });\n\n      canvases = canvases.filter(function (annotationView) {\n        return annotationView.videoFeed.stream.connection.connectionId !== connectionId;\n      });\n    };\n\n    /**\n     * Removes the toolbar and all associated annotation canvases from their parent containers.\n     */\n    this.remove = function () {\n\n      try {\n        panel.parentNode.removeChild(panel);\n      } catch (e) {\n        console.log('Toolbar parent no longer exists');\n      }\n\n      canvases.forEach(function (annotationView) {\n        var canvas = annotationView.canvas();\n        if (canvas.parentNode) {\n          canvas.parentNode.removeChild(canvas);\n        }\n      });\n\n      canvases = [];\n    };\n  };\n\n}.call(this));\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}